# NAME OF YOUR MODEL OR COMPONENT HERE
#
# For more information about the extended YAML syntax, please consult:
# https://esm-tools.readthedocs.io/en/latest/yaml.html#esm-tools-extended-yaml-syntax
#
# For more information about the ESM-Tools feature variables available, please consult:
# https://esm-tools.readthedocs.io/en/latest/esm_variables.html#esm-tools-variables

model: cryogrid
type: permafrost
version: "1.0.0"
available_versions:
    - "1.0.0"
metadata:
        Institute: Alfred Wegener Institute Helmholtz Centre for Polar and Marine Research
        Description:
                Custom Julia implementation of the CryoGrid permafrost model. This version of CryoGridLite.jl is intended for being used in a coupled setup with AWI-ESM.
        Authors: Moritz Langer (moritz.langer@awi.de), Jan Nitzbon (jan.nitzbon@awi.de)
        Publications:
                - "Langer, M., Nitzbon, J., Groenke, B., Assmann, L.-M., Schneider von Deimling, T., Stuenzi, S. M., & Westermann, S. (2022). The evolution of Arctic permafrost over the last three centuries. EGUsphere, 1â€“27. <https://doi.org/10.5194/egusphere-2022-473>"
        License:
                Creative Commons Attribution 4.0 International

git-repository: "https://gitlab.awi.de/paleodyn/Models/CryoGridLite.jl"
branch: coupling-awiesm
comp_command: ""
install_bins: "/"
#clean_command: ${defaults.clean_command}
# Some recommended defaults
lresume: 0
nproc: 1

#executable: run_CGLite_esmtools.sh ${nproc_julia} ${start_date!syear} ${lresume} #${forcing_file} ${input_file} ${exp_path} ${exp_id} #${lresume}
        #execution_command: "/bin/bash julia --project=. --threads=1 -p ${nproc_julia} CGLite.jl --forcing-file forcing.cglite.${start_date!syear}.nc --input-file para.cglite.nc"

#choose_version:
    # Here you can place all the variables you would want to control via the version
    # variable above (for example, you could also add ``git-repository``,
    # ``comp_command``, ``destination``, ...) 
    #a_version_of_your_choice:
    #    branch: name of the branch/tag associated to that version if you use git
    #another_version_of_your_choice:
    #    branch: name of the branch/tag associated to that version if you use git

# ``model_dir`` let's ESM-Tools know where is the source code of your component (must
# be an absolute path). Normally, changed via the runscript. We recommend you leave it
# as below, changing only the ``name_of_your_model`` part to whatever you defined as 
# the ``model`` var. This will automatically select the source code for esm_master if
# the command is operating with a coupled setup
model_dir: "${general.esm_master.dir}/cryogrid-${version}"

# This section takes care of dealing with environment changes you might want to do, to
# deviated from the defaults define for the specific machine
# (``configs/machine/<the_machine_used>.yaml``). For more information consult:
# https://esm-tools.readthedocs.io/en/latest/esm_environment.html#esm-environment
environment_changes:
    add_module_actions: #- module command without ``module`` word (e.g. ``load netcdf``)
        - "load julia"
    add_export_vars: 
        JULIA_NUM_THREADS: 1
choose_lresume:
    0:
        add_environment_changes: 
            execution_command: "julia --project=. --threads=1 -p ${cryogrid.nproc} CGLite.jl --forcing-file forcing.cglite.${start_date!syear}.nc --input-file para.cglite.nc"
    1:
        add_environment_changes:
            execution_command: "julia --project=. --threads=1 -p ${cryogrid.nproc} CGLite.jl --forcing-file forcing.cglite.${start_date!syear}.nc --input-file restart.cglite.nc -r"


# Some commonly used variables in other ESM-Tools components (but optional)
#input_dir: ${pool_dir}/path/within/the/pool/dir/to/the/input/of/your/component
#namelist_dir: /absolute/path/to/the/namelist/folder

# If your components has namelist the following syntax allows you to control the values
# of their values. For more information consult:
# https://esm-tools.readthedocs.io/en/latest/yaml.html#changing-namelists
#namelist_changes:
#    namelist_name:
#        section_in_the_namelist:
#            variable_in_the_namelist: its new value here

#namelists:
#    - name of the namelist

# File dictionaries to control the copying/moving/linking of all files associated to
# the simulation. This syntax will change for something better soon. For more details
# about this syntax consult:
# https://esm-tools.readthedocs.io/en/latest/yaml.html#file-dictionaries



input_sources:
    para_cglite_T63: "/albedo/work/user/jnitzbon/CGLite/input/para_netcdf/para_cglite_awiesm_T63.nc"
    para_jsbach_T63: "/albedo/work/user/jnitzbon/CGLite/input/para_netcdf/PARA.nc"
input_files:
    para: para_cglite_T63
#input_in_work:
 #   para: "para_for_cryogrid.nc"
input_targets:
    para: "para.cglite.nc"

forcing_sources:
    ini_forcing: ${ini_forcing_file} # to be defined in runscript
forcing_files:
    ini_forcing: ini_forcing
forcing_targets:
    ini_forcing: forcing.cglite.${start_date!syear}.nc
#forcing_in_work:
#    ini_forcing: "forcing_for_cryogrid.nc"

bin_sources:
    run_script: ${model_dir}/run_CGLite_esmtools.sh # This would be the normal way to do it
    cglite_script: ${model_dir}/CGLite.jl
    src: ${model_dir}/src/*
    project: ${model_dir}/Project.toml
    manifest: ${model_dir}/Manifest.toml
bin_targets:
    run_script: run_CGLite_esmtools.sh
    cglite_script: CGLite.jl
    src: src/*
    project: Project.toml
    manifest: Manifest.toml

    
outdata_in_work:
    output: output.cglite.*.nc
outdata_targets:
    output: output.cglite.${end_date!syear}.nc

restart_in_sources:
    restart_in: restart.cglite.$(( ${start_date!syear} - 1 )).nc
restart_in_targets:
    restart_in: restart.cglite.nc #remove year tag so that it is not considered by restart_out

restart_out_sources:
    restart_out: restart.cglite.*.nc
restart_out_in_work:
    restart_out: restart.cglite.*.nc
restart_out_targets:
    restart_out: restart.cglite.${end_date!syear}.nc

#create_config:
#        cryogrid_wrapper.sh:
#                - "<--append-- #!/bin/bash"
#                - "<--append-- julia --project=. --threads=1 -p ${nproc_julia} CGLite.jl --forcing-file forcing_for_cryogrid.nc --input-file para_for_cryogrid.nc"




