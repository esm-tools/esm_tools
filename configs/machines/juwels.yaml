# JUWELS YAML CONFIGURATION FILE

batch_system: slurm

name: juwels 
account: esmtst
jobtype: compute
accounting: true

sh_interpreter: "/usr/bin/bash"
launcher_flags: "-l"
hyperthreading_flag: "--ntasks-per-core=1"

pool_directories:
        pool: "/pool/data/not/available/on/blogin"
        focipool: "/p/project/cesmtst/esmtst22/foci_input2"

pool_dir:  "/pool/data/not/available/on/blogin"

choose_jobtype:
        tidy_and_resubmit:
                partition: devel 
        post:
                partition: devel
        compute:
                partition: devel


choose_partition:
        batch:
                cores_per_node: 24
        devel:
                cores_per_node: 24

logical_cpus_per_core: 2

threads_per_core: 1

useCompiler: bareIntel19mpi

module_actions:
        - "--force purge"
        - "use /gpfs/software/juwels/otherstages"
        - "load Stages/Devel-2019a"
        - "load GCCcore/.8.3.0"
        - "load CMake"
        - "load Intel/2019.5.281-GCC-8.3.0"
        - "load IntelMPI/2019.6.154"
        - "load Python/3.6.8"

export_vars:
        - "FC=mpiifort"
        - "F77=mpiifort"
        - "MPIFC=mpiifort"
        - "FCFLAGS=-free"
        - "CC=mpiicc"
        - "CXX=mpiicpc"

        - "MPIROOT=\"$(mpiifort -show | perl -lne 'm{ -I(.*?)/include } and print $1')\""
        - "MPI_LIB=\"$(mpiifort -show |sed -e 's/^[^ ]*//' -e 's/-[I][^ ]*//g')\""


choose_useCompiler:
        # FOCI and FOCIOIFS use their own compiled libraries (netcdf, hdf5, ...) to avoid the massive 
        # dependencies build into the modules on JUWELS
        # source: https://git.geomar.de/HPC/libraries/-/blob/master/DOC/compile_libraries_juwels.sh
        bareIntel19mpi:
                add_module_actions:
                        - "source /gpfs/software/juwels/stages/Devel-2019a/software/impi/2019.6.154-iccifort-2019.3.199-GCC-8.3.0/bin/mpivars.sh release_mt" 
                add_export_vars:
                        - "IO_LIB_ROOT=/p/project/cesmtst/esmtst22/gitlab/HPC_libraries/intel2019.3.199_impi2019.6.154_20191213"
                        - "LD_LIBRARY_PATH=$IO_LIB_ROOT/lib:$LD_LIBRARY_PATH"

                        - "SZIPROOT=$IO_LIB_ROOT"
                        - "HDF5ROOT=$IO_LIB_ROOT"
                        - "HDF5_ROOT=$HDF5ROOT"
                        - "NETCDFROOT=$IO_LIB_ROOT"
                        - "NETCDFFROOT=$IO_LIB_ROOT"

                        - "HDF5_C_INCLUDE_DIRECTORIES=$HDF5_ROOT/include"
                        - "NETCDF_Fortran_INCLUDE_DIRECTORIES=$NETCDFFROOT/include"
                        - "NETCDF_C_INCLUDE_DIRECTORIES=$NETCDFROOT/include"
                        - "NETCDF_CXX_INCLUDE_DIRECTORIES=$NETCDFROOT/include"
                        - 'OASIS3MCT_FC_LIB="-L$NETCDFFROOT/lib -lnetcdff"'

further_reading:
        - batch_system/slurm.yaml
