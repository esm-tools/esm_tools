#
#OIFS standalone YAML FILE
#

model: oifs
executable: oifs
execution_command: ${executable} -e ${oifs.input_expid}
version: 43r3
type: atmosphere
with_xios: false # TODO: Change to true when the run bug is fixed (compile bug was fixed)
with_nest1: false
xml_dir: ''

required_plugins:
        - "git+https://github.com/esm-tools-plugins/postprocess"
        - "git+https://github.com/esm-tools-plugins/preprocess"

description: |
        The OpenIFS atmosphere model based on ECMWF IFS
        Carver et al., in prep.

license_text: |
        ECMWF license. AWI and GEOMAR have licenses.

# Force namelist fort.4 to be written in uppercase
namelist_case: "uppercase"

reusable_filetypes: [input, bin, src]

##
## Directories
##

model_dir: ${general.model_dir}
setup_dir: ${model_dir}
bin_dir: ${setup_dir}/bin
#bin_dir: ${model_dir}/bin
# seb-wahl: make focipool default until all OIFS data is available
# in the "general" pool directory
# JS: can use just use ${computer.pool_directories.pool} by now?
pool_dir: "${computer.pool_directories.focipool}"
input_dir: ${pool_dir}
rtables_dir: ${input_dir}/../rtables/
vtables_dir: ${input_dir}/../vtables/
clim_dir: ${input_dir}/../
icmcl_dir: ${input_dir}
icmcl_file: ICMCL${prepifs_expid}INIT
forcing_dir: ${input_dir}/../${version}/ifsdata/
ifsdata_dir: ${input_dir}/../${version}/ifsdata/
namelist_dir: ${general.esm_namelist_dir}/oifs/${version}/
cmip6_data_dir: ${input_dir}/../cmip6_data
cmip5_data_dir: ${input_dir}/../cmip5_data
cmip6_data_dir_nml: ${cmip6_data_dir}
cmip5_data_dir_nml: ${cmip5_data_dir}
restart_dir: ""
in_date_folder: "${parent_date!syear!smonth!sday}"
out_date_folder: "${end_date!syear!smonth!sday}"

parent_expid: "test"
parent_dir: "${pool_dir}/OPENIFS43R3-TCO95/restart/${parent_expid}"

# Default is TL159L91
# Forcing from gu5a prepIFS forcing
#
# Note: input_expid is the expid that will appear on
#       the input and forcing files in the work directory
#       prepifs_expid is the expid that appears on the
#       input and forcing files in input_dir and forcing_dir
#       Default is a TL159 run, input data from ECMWF has expid gu5a
#       but I want the expid for my run to be ECE3.

metadata:
        Name: OpenIFS
        Institute: ECMWF
        Description:
                OpenIFS provides research institutions with an easy-to-use version
                of the ECMWF IFS (Integrated Forecasting System).
        Authors: Glenn Carver (openifs-support@ecmwf.int)
        Website: https://www.ecmwf.int/en/research/projects/openifs
        License:
                Please make sure you have a licence to use OpenIFS. In case you are
                unsure, please contact redmine...

compile_infos:
        contact: "jan.streffing(at)awi.de, miguel.andres-martinez(at)awi.de"
        # this require currently causes esm_master install-... to not work properly
        # workaround esm_master get-... ; esm_master comp-...
        requires:
        - oasis3mct-4.0
        available_versions:
        - 40r1
        - 43r3-master
        - 43r3-awicm-3.0
        - 43r3-awicm-3.1
        - 43r3-awicm-frontiers-xios
        - 43r3
        - 40r1-foci
        - 43r3-foci
        - 40r1-agcm
        - 43r3-v1
        choose_version:
          40r1:
            branch: foci_conserv
          "40r1-agcm":
            compile_command: export OIFS_COMP=agcm; cd make; ../fcm/bin/fcm make -v -j8 -f
              oifs-agcm.cfg
          40r1-foci:
            branch: foci_conserv
            comp_command: cd make; ../fcm/bin/fcm make -v -j24 -f oifs.cfg
            destination: 40r1
            contact: "swahl(at)geomar.de"
          43r3-master:
            requires:
            - oasis3mct-5.0-smhi
            branch: development/2022/awi-cm3-integration
            executable: OpenIFS
            comp_command: "export OIFS_CPLNG_LIB=$OIFS_OASIS_LIB; export OIFS_CPLNG_INCLUDE=$OIFS_OASIS_INCLUDE ;export OIFS_COMP=esm; export OIFS_BUILD=opt; export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable; export OIFS_CPLNG=enable; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/; cd make; ../fcm/bin/fcm make -v -j10 -f oifs_esm.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/OpenIFS"
            git-repository: https://git.smhi.se/jan.streffing/oifs43r3/
            install_bins: make/esm/oifs/bin/OpenIFS
            destination: oifs-43r3
            with_xios: true
          43r3-awicm-3.0:
            requires:
            - oasis3mct-4.0-awicm-3.0
            branch: awicm3-frontiers-freeze-candidate-1
            comp_command: export OIFS_TOPLEVEL_DIR=${model_dir}; cd make; ../fcm/bin/fcm make
              -v -j8 -f oifs.cfg ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            install_bins: make/esm/oifs/bin/oifs
            destination: oifs-43r3
            with_xios: false # for now, later the default will be with_xios: true
          43r3-awicm-3.1:
            requires:
            - oasis3mct-4.0-awicm-3.1
            branch: awicm-3.1
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            install_bins: make/esm/oifs/bin/oifs
            destination: oifs-43r3
            with_xios: true
          43r3-awicm-frontiers-xios:
            requires:
            - oasis3mct-4.0-awicm-frontiers
            branch: awicm-3-frontiers-xios
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            install_bins: make/esm/oifs/bin/oifs
            destination: oifs-43r3
            with_xios: true
          43r3:
            branch: oifs-deck
            comp_command: export OIFS_TOPLEVEL_DIR=${model_dir}; cd make; ../fcm/bin/fcm make
              -v -j8 -f oifs.cfg ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            install_bins: make/esm/oifs/bin/oifs
            with_xios: false
          43r3-foci:
            branch: 43r3v1-foci
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            install_bins: make/esm/oifs/bin/oifs
            requires:
            - oasis3mct-4.0
            - xios-2.5_r1910
            contact: "swahl(at)geomar.de"
          43r3-foci21:
            branch: master
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            install_bins: make/esm/oifs/bin/oifs
            requires:
            - oasis3mct-EM21
            - xios-2.5_r1910
            contact: "swahl(at)geomar.de"
          43r3-foci211:
            branch: foci211
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            install_bins: make/esm/oifs/bin/oifs
            requires:
            - oasis3mct-EM21
            - xios-2.5_r1910
            contact: "swahl(at)geomar.de"
          43r3-v1:
            branch: 43r3v1-foci
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            install_bins: make/esm/oifs/bin/oifs
            requires:
            - oasis3mct-4.0
            - xios-2.5_r1910_oifs
          43r3-v2:
            branch: master
            git-repository: https://gitlab.dkrz.de/ec-earth/oifs-43r3.git
            comp_command: "export OIFS_TOPLEVEL_DIR=${model_dir}; export OIFS_XIOS=enable ; export OIFS_XIOS_DIR=${model_dir}/../xios ; export OIFS_XIOS_INCLUDE=-I/${model_dir}/../xios/inc/ ; cd make; ../fcm/bin/fcm make -v -j8 -f oifs.fcm ; mv esm/oifs/bin/master.exe esm/oifs/bin/oifs"
            install_bins: make/esm/oifs/bin/oifs
            requires:
            - oasis3mct-4.0
            - xios-2.5_r1910_oifs
        clean_command: rm -rf make/esm
        comp_command: cd make; ../fcm/bin/fcm make -v -j8 -f oifs.cfg
        git-repository: https://gitlab.dkrz.de/modular_esm/oifs-40r1.git
        install_bins: make/esm/oifs/bin/master.exe

further_reading:
        - oifs/oifs.env.yaml

compiletime_environment_changes:
        iolibraries: geomar_libs
        choose_computer.name:
                juwels:
                        compiler_mpi: intel2020_psmpi2020
runtime_environment_changes:
        iolibraries: geomar_libs
        choose_computer.name:
                juwels:
                        compiler_mpi: intel2020_psmpi2020

input_expid: ECE3
resolution: TL159
levels: L91
nlev: ${levels_number}
prepifs_expid: gu5a
prepifs_startdate: 19820101
mip: "cmip5"
o3_scheme: "default"
scenario: "amip-prepifs"
output: "default"

wam: False
wam_2w: True
wam_step: 1
read_icmcl: 0
generate_namelist: 1
ensemble: 0
post_processing: 0
solarspectrum: False
pextra: 0
dr_hook_ignore_signals: -1

#cmip6: True
#cmip5: False
#cmip6_scenario: "pictrl"
#cmip5_scenario: 0
cmip_fix_year: 0
a4xco2: False
onepctco2: False
lhvolca: False

supercooled_liquid_could_fix: 0

# If perturb = 1, then we perturb the initial SKT in ICMGGECE3INIT
# with random numbers generated using CDO
# We use ensemble_id as seed, so this number must be unique for each member
# i.e. ensemble_id = N for r1iNp1
perturb: 1
ensemble_id: 1

orb_switch: False
orb_mode: "variable_year"
orb_iyear: ${start_date!syear}

restart: 1

threads: 1
ny: 1

hours: "00"

namelists:
        - "fort.4"
        - "wam_namelist"

choose_resolution:
        # Note:
        # Tco grids only work with version 43r3.
        TCO95:
                nx: 40320
                ny: 1
                time_step: 3600
                oasis_grid_name: "096"
                res_number: 95
                res_number_tl: "95_4"
                truncation: "TCO"
        TL159:
                nx: 35718
                ny: 1
                time_step: 3600
                oasis_grid_name: "080"
                res_number: 159
                res_number_tl: "159l_2"
                truncation: "TL"
        TCO159:
                nx: 108160
                ny: 1
                time_step: 3600
                oasis_grid_name: "160"
                res_number: 159
                res_number_tl: "159_4"
                truncation: "TCO"
        TCO199:
                nx: 167200
                ny: 1
                time_step: 1800
                oasis_grid_name: "200"
                res_number: 199
                res_number_tl: "199_4"
                truncation: "TCO"
        TL255:
                nx: 88838
                ny: 1
                time_step: 2700
                oasis_grid_name: "128"
                res_number: 255
                res_number_tl: "255l_2"
                truncation: "TL"
        TCO319:
                nx: 421120
                ny: 1
                time_step: 1200
                oasis_grid_name: 320
                res_number: 319
                res_number_tl: "319_4"
                truncation: "TCO"
        TCO399:
                nx: 654400
                ny: 1
                time_step: 1200
                oasis_grid_name: 400
                res_number: 399
                res_number_tl: "399_4"
                truncation: "TCO"
        TCO639:
                nx: 1661440
                ny: 1
                time_step: 600
                oasis_grid_name: 640
                res_number: 639
                res_number_tl: "639_4"
                truncation: "TCO"
        TL511:
                nx: 348528
                ny: 1
                time_step: 900
                oasis_grid_name: "256"
                res_number: 511
                res_number_tl: "511l_2"
                truncation: "TL"
        TL799:
                nx: 843490
                ny: 1
                time_step: 600
                oasis_grid_name: "400"
                res_number: 799
                res_number_tl: "799l_2"
                truncation: "TL"
        TL1279:
                nx: 2140702
                ny: 1
                time_step: 600
                oasis_grid_name: "640"
                res_number: 799
                res_number_tl: "1279l_2"
                truncation: "TL"

choose_computer.partitions.compute.cores_per_node:
        24:
                nproc: 96
        36:
                nproc: 108
        48:
                nproc: 96
        96:
                nproc: 96

#======================================================================================
# MAIN CHANGES TO fort.4 NAMELIST
#======================================================================================

# Microphysics switch: 0 for off, 1 for light version and 2 for full
sclct_switch: 0

# Namelist modifications for truncation types
nlon: "$(( ${nlat}*2 ))"
nspecresmin: "$(( ${res_number}+1 ))"
choose_truncation:
        TCO:
                nlat: "$(( (${res_number}+1)*2 ))"
                lecompgrid: true
                lgradsp: false
                lassi: false
                lfdbop: false
                lsmssig: false
        TL:
                nlat: "$(( ${res_number}+1 ))"
                lecompgrid: false
                lgradsp: true
                lassi: true
                lfdbop: true
                lsmssig: true

# Apply truncation and other general options to the namelist
namelist_changes:
        fort.4:
                NAERAD:
                        CRTABLEDIR: "${rtables_dir}"
                        LECOMPGRID: "${lecompgrid}"
                NAMFPG:
                        NFPLEV: "${nlev}"
                        NFPMAX: "${res_number}"
                NAMFPD:
                        NLAT: "${nlat}"
                        NLON: "${nlon}"
                NAMPAR0:
                        NSPECRESMIN: "${nspecresmin}"
                NAMDYNA:
                        LGRADSP: "${lgradsp}"
                NAMNMI:
                        LASSI: "${lassi}"
                NAMCT0:
                        LFDBOP: "${lfdbop}"
                        LSMSSIG: "${lsmssig}"
                # For this changes to have an effect use a version of OpenIFS that
                # contains yomorb.F90
                NAMORB:
                        LCORBMD:  "${orb_switch}"
                        ORBMODE: "${orb_mode}"
                        ORBIY: "${orb_iyear}"


lresume: false
restart_rate: 1
restart_unit: "months"

file_movements:
        forcing:
            all_directions: link
        restart_in:
            all_directions: link
        restart_out:
            all_directions: move
        rcf_in:
            all_directions: copy
        waminfo_in:
            all_directions: copy
        outdata: # TODO: ask GEOMAR if they are fine with this, otherwise we have to put it into awicm3.yaml
            all_directions: move

# TODO: expand comment
massfixer: 2
cloudfixer: 1
nfrmasscon: 1

oasis_grid_name_a: "A${oasis_grid_name}"
oasis_grid_name_r: "R${oasis_grid_name}"
oasis_grid_name_l: "L${oasis_grid_name}"

choose_levels:
        L60:
                levels_number: 60
        L62:
                levels_number: 62
        L91:
                levels_number: 91
        L137:
                levels_number: 137


#======================================================================================
# TIME VARIABLES
#======================================================================================
# Time variables are needed for correctly copying srf and WAM files, but also for being
# able to use Jan Streffing's strategy to avoid OIFS from crashing during very long
# runs, associated to the well known memory issue documented here:
#     https://confluence.ecmwf.int/pages/viewpage.action?pageId=192905300

# Simulaton length for the fort.4 namelist and wam_namelist
simulation_length_seconds: "$(( ${next_date} - ${pseudo_initial_date} ))"
seconds_since_initial: "$(( ${start_date} - ${pseudo_initial_date} ))"
wam_start_date: "${pseudo_initial_date!syear!smonth!sday}000000"

# ICMCL start and end
icmcl_end_date: "$(( ${next_date} + 1days ))"
icmcl_end_date_formatted: "${icmcl_end_date!syear!smonth!sday}"

# Time steps in this run
runtime_seconds: "$(( ${next_date} - ${start_date} ))"
timestep_per_run: $((${runtime_seconds} / ${time_step}))

# Number of days in this run
ndays_per_run: "$(( ${runtime_seconds} / 86400 ))"
ndays_per_run_string: "<--format(%08d)-- ${ndays_per_run}"

# Number of steps since the beginning of the simulation or the "pseudo-beginning"
steps_since_initial: $((${seconds_since_initial} / ${time_step}))

# Number of total steps at the end of the run
next_step: "$(( ${steps_since_initial} + ${timestep_per_run} ))"

# Number of steps per day in this run
steps_per_day: "$(( 86400 / ${time_step} ))"

# By default we output one restart per run
nfrres: 1


#======================================================================================
# BINARY FILES
#======================================================================================
bin_sources:
        bin: ${bin_dir}/${executable}


#======================================================================================
# INPUT FILES
#======================================================================================

input_files:
        ICMGG_INIT: ICMGG_INIT
        ICMGG_INIUA: ICMGG_INIUA
        ICMSH_INIT: ICMSH_INIT
        ifsdata: ifsdata
        #rtables: rtables
        #vtables: vtables
        tl_data: tl_data
        o3_data: o3_data
        # also missing: modify_init for ensemble stuff


#======================================================================================
# FORCING FILES
#======================================================================================

# Switch to copy the forcing files into the experiment input folder. If false, the
# forcing files are accessed directly from the pool
copy_forcing: false
choose_copy_forcing:
        true:
                forcing_files:
                        O3PI: O3PI
                        O3HIST: O3HIST
                        O3SCEN: O3SCEN
                choose_mip:
                        "cmip5":
                                cmip5_data_dir_nml: ./cmip5_data/
                                add_forcing_files:
                                        PRE2005_MIDYR_CONC: PRE2005_MIDYR_CONC
                                        RCP3PD_MIDYR_CONC: RCP3PD_MIDYR_CONC
                                        RCP45_MIDYR_CONC: RCP45_MIDYR_CONC
                                        RCP6_MIDYR_CONC: RCP6_MIDYR_CONC
                                        RCP85_MIDYR_CONC: RCP85_MIDYR_CONC
                        "cmip6":
                                cmip6_data_dir_nml: ./cmip6_data/
                                add_forcing_files:
                                        # Add CO2 etc for all scenarios and years
                                        CMIP6DATA: CMIP6DATA

        false:
                forcing_files: {}


#======================================================================================
# LOG FILES
#======================================================================================

log_files:
        NODE: NODE
        ifsstat: ifsstat

log_sources:
        NODE: NODE.001_01
        ifsstat: ifs.stat

log_in_work:
        NODE: NODE.001_01
        ifsstat: ifs.stat


#======================================================================================
# RESTART FILES
#======================================================================================

# NDAYS variables for SRF and WAMINFO files
# -----------------------------------------
# ndays_source_in
ndays_source_in: "<--format(%08d)-- ${start_ndays_source}"
# ndays_work_in
start_ndays: "$(( ${seconds_since_initial} / 86400 ))"
ndays_work_in: "<--format(%08d)-- ${start_ndays}"
# ndays_out
next_ndays: "$(( ${simulation_length_seconds} / 86400 ))"
ndays_out: "<--format(%08d)-- ${next_ndays}"

# WAM variables
# -------------
# filebase
filebase_wam_source: "${prev_run.oifs.filebase_wam_work}"
filebase_wam_work: "${pseudo_initial_date!syear!smonth!sday}000000_"
# wam_source_in
source_ndays_wam: "$(( ${start_ndays_source} - 1 ))"
source_days_string: "<--format(%06d)-- ${source_ndays_wam}"
wam_source_in: "${source_days_string}${parent_date!shour!sminute!ssecond}"
# wam_work_in
start_ndays_wam: "$(( ${start_ndays} - 1 ))"
start_days_string: "<--format(%06d)-- ${start_ndays_wam}"
wam_work_in: "${start_days_string}${parent_date!shour!sminute!ssecond}"
# wam_out
next_ndays_wam: "$(( ${next_ndays} - 1 ))"
next_days_string: "<--format(%06d)-- ${next_ndays_wam}"
wam_out: "${next_days_string}${parent_date!shour!sminute!ssecond}"

# BEFORE RUN: copy from RESTART to WORK
# ----------
restart_in_files:
        srf: srf
        rcf: rcf

# RESTART (restart files from prev. leg in the general exp dir):
restart_in_sources:
        srf: ${in_date_folder}/srf${ndays_source_in}0000.*
        rcf: ${in_date_folder}/rcf
        waminfo: ${in_date_folder}/waminfo${ndays_source_in}
        BLS: ${in_date_folder}/BLS${filebase_wam_source}${wam_source_in}.*
        LAW: ${in_date_folder}/LAW${filebase_wam_source}${wam_source_in}.*

# WORK (current leg directory):
restart_in_in_work:
        rcf: rcf
        waminfo: waminfo
        srf: srf${ndays_work_in}0000.*
        BLS: BLS${filebase_wam_work}${wam_work_in}.*
        LAW: LAW${filebase_wam_work}${wam_work_in}.*


# AFTER RUN: copy from WORK to RESTART
# ---------
restart_out_files:
        srf: srf
        rcf: rcf

# WORK (restart files generated during this leg, to be copied to the exp dir):
restart_out_sources:
        srf: srf${ndays_out}0000.*
        rcf: rcf
        waminfo: waminfo
        BLS: BLS${filebase_wam_work}${wam_out}.*
        LAW: LAW${filebase_wam_work}${wam_out}.*

# RESTART (restart files from this leg in the general exp dir, for the next leg restart)
restart_out_targets:
        srf: ${out_date_folder}/srf${ndays_out}0000.*
        rcf: ${out_date_folder}/rcf
        waminfo: ${out_date_folder}/waminfo${ndays_out}
        BLS: ${out_date_folder}/BLS${filebase_wam_work}${wam_out}.*
        LAW: ${out_date_folder}/LAW${filebase_wam_work}${wam_out}.*


#======================================================================================
# OUTPUT FILES
#======================================================================================

outdata_in_work:
        ICMGG: ICMGG${oifs.input_expid}+*
        ICMSH: ICMSH${oifs.input_expid}+*
        ICMUA: ICMUA${oifs.input_expid}+*
        MPP: MPP*
        # XIOS output
        oifsnc: ${input_expid}_*_${start_date!syear!smonth!sday}_*.nc
        atm: atm_*

outdata_sources:
        # old grib based output
        ICMGG: ${out_date_folder}/ICMGG${oifs.input_expid}+*
        ICMSH: ${out_date_folder}/ICMSH${oifs.input_expid}+*
        ICMUA: ${out_date_folder}/ICMUA${oifs.input_expid}+*
        MPP: ${out_date_folder}/MPP*
        # XIOS output
        oifsnc: ${input_expid}_*_${start_date!syear!smonth!sday}_*.nc
        atm: atm_*


#======================================================================================
# IGNORE FILES
#======================================================================================

ignore_files:
        drhook: drhook
        ICMCL: ICMCL
ignore_in_work:
        drhook: drhook*
        ICMCL: ICMCL*
ignore_sources:
        drhook: drhook*
        ICMCL: ICMCL*


#======================================================================================
# XIOS (Parallel output via XML IO server)
#======================================================================================

# Using XIOS?
choose_with_xios:
        1:
                include_models:
                        - xios
                add_namelist_changes:
                        fort.4:
                                NAMCT0:
                                        LXIOS: ".true."
                outdata_files:
                        oifsnc: oifsnc
                        atm: atm
        0:
                outdata_files:
                        ICMGG: ICMGG
                        ICMSH: ICMSH


#======================================================================================
# PEXTRA (Output of additional fields that are not part of standard OpenIFS output)
#======================================================================================

choose_pextra:
        1:
                add_namelist_changes:
                        fort.4:
                                NAEPHY:
                                        LBUD23: ".true."
                                NAMDPHY:
                                        NVEXTR: 25
                                NAMPHYDS:
                                        NVEXTRAGB: [91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115]
                                NAMFPC:
                                        NFP3DFS: 25
                                        MFP3DFS: [91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115]


#======================================================================================
# WAVE MODEL (WAM)
#======================================================================================

# Turns on/off the wave model WAM inside OpenIFS
choose_wam:
        1:
                wam_number: "1"

                add_input_files:
                        wam_grid_tables: wam_grid_tables
                        wam_subgrid_0: wam_subgrid_0
                        wam_subgrid_1: wam_subgrid_1
                        wam_subgrid_2: wam_subgrid_2
                        uwavein: uwavein
                        specwavein: specwavein
                        sfcwindin: sfcwindin
                        cdwavein: cdwavein

                add_namelist_changes:
                        fort.4:
                                NAEPHY:
                                        LWCOU: ".true."
                                        LWCOU2W: ".true."
                        wam_namelist:
                                NALINE:
                                        CBPLTDT: "${wam_start_date}"
                                        CDATECURA: "${wam_start_date}"
                                        CDATEF: "${wam_start_date}"

                add_restart_in_files:
                        BLS: BLS
                        LAW: LAW
                        waminfo: waminfo
                add_restart_out_files:
                        BLS: BLS
                        LAW: LAW
                        waminfo: waminfo

                add_outdata_files:
                        MPP: MPP

                add_config_sources:
                        "wam_namelist": "${namelist_dir}/wam_namelist"

        0:
                wam_number: "0"

                add_namelist_changes:
                        fort.4:
                                NAEPHY:
                                        LWCOU: ".false."
                                        LWCOU2W: ".false."


#======================================================================================
# OTHER CONFIGS AND SWITCHES
#======================================================================================

##
## mass conservation / mass fixer
## 0 - no mass fixer
## 1 - mass fixer for dry mass
## 2 - mass fixer for dry mass and cloud variables
##
## LMASCOR turns it on/off
## NFRMASSCON is correction frequency in time steps
## (once per day might be ok)
##
choose_massfixer:
        0:
                add_namelist_changes:
                        fort.4:
                                NAMDYN:
                                        LMASCOR: ".false."
        1:
                add_namelist_changes:
                        fort.4:
                                NAMDYN:
                                        LMASCOR: ".true."
                                        LMASDRY: ".false."
                                NAMCT0:
                                        NFRMASSCON: ${oifs.nfrmasscon}
        2:
                add_namelist_changes:
                        fort.4:
                                NAMDYN:
                                        LMASCOR: ".true."
                                        LMASDRY: ".false."
                                NAMCT0:
                                        NFRMASSCON: ${oifs.nfrmasscon}
                                NAMGFL:
                                        #LTRCMFIX_PS: ".true."
                                        LTRCMFMG: ".true."
                                        YS_NL%LMASSFIX: ".true."
                                        YR_NL%LMASSFIX: ".true."
                                        YI_NL%LMASSFIX: ".true."
                                        YL_NL%LMASSFIX: ".true."
                                        YQ_NL%LMASSFIX: ".true."


choose_cloudfixer:
        1:
                add_namelist_changes:
                        fort.4:
                                NAMCLDP:
                                        SCLCT_SWITCH: "${sclct_switch}"

##
## specifics for 40r1 and 43r3
##

choose_version:
        40r1:
                add_namelist_changes:
                        fort.4:
                                NAMRES:
                                        #NFRRES: ${oifs.next_step}
                                        NFRRES: 1
                                        NRESTS: "-1, -${oifs.next_step}"

                                NAMPAR0:
                                        NPROC: ${oifs.nproc}

                                NAMDYN:
                                        TSTEP: ${oifs.time_step}

                                NAMCT0:
                                        CNMEXP: ${oifs.input_expid}
                                        NSTOP: ${oifs.next_step}

                                NAMFOCICFG:
                                        # By default, turn off coupling
                                        FOCI_CPL_NEMO_LIM: ".false."

                environment_changes:
                        add_export_vars:
                                - 'OIFS_FFIXED="-fixed"'
                                - 'DR_HOOK_IGNORE_SIGNALS="-1"'
                                - 'OIFS_EXPID="${input_expid}"'
                                - 'FOCI_USE_CPLNG="no"'
                                - 'FESOM_USE_CPLNG="no"'
                                - 'ECE_USE_CPLNG="no"'

        43r3:
                add_namelist_changes:
                        fort.4:
                                NAMRES:
                                        NFRRES: ${nfrres}
                                        NRESTS${nrest_ind}: ${nfrests}
                                NAMPAR0:
                                        NPROC: ${oifs.nproc}
                                NAMARG:
                                        UTSTEP: ${oifs.time_step}
                                        CNMEXP: "${oifs.input_expid}"
                                        CUSTOP: "t${oifs.next_step}"
                                NAMPPC:
                                        LRSACC: ".true." # reset accumulation of fluxes

                add_outdata_files:
                        ICMUA: ICMUA


# If 1, use Coddington spectrum which reduced stratospheric warm bias
# Only available in 43r3-v2
choose_solarspectrum:
        True:
                add_namelist_changes:
                        fort.4:
                                NAERAD:
                                        NSOLARSPECTRUM: 1

# There are two different O3 concentrations in OpenIFS:
# One is used for output, and one that is used by radiation scheme
# By default, the two are NOT the same.
# By default, prognostic O3 from the Cariolle scheme is written to output
# but climatology is used by radiation scheme
#
# Here the scheme can be changed in two ways:
# cmip6: Use O3 from CMIP6 (input4MIP) for picontrol, historical or scenarios
# cariolle: Use the prognostic O3 from Cariolle in radiation
choose_o3_scheme:
        default:
                add_namelist_changes:
                        fort.4:
                                NAERAD:
                                        NGHGRAD: 21
        cmip6:
                # For CMIP6 O3 we set
                # LCMIP6O3 to true
                # LEO3VAR to true
                # LEPO3RA to false (otherwise prognostic O3 is used)
                add_namelist_changes:
                        fort.4:
                                NAMGFL:
                                        YO3_NL%LGP: '.true.' # O3 is a tracer
                                NAEPHY:
                                        LEO3CH: '.true.' # turn on O3 scheme
                                NAERAD:
                                        LEPO3RA: '.false.' # dont use progn O3 in radiation
                                        LCMIP6O3: '.true.' # use CMIP6 O3
                                        LEO3VAR: '.true.'  # allow time-varying O3 (not climatology)
                                        NGHGRAD: 21        # dont overwrite by progn O3

        cariolle:
                # For Cariolle
                add_namelist_changes:
                        fort.4:
                                NAMGFL:
                                        YO3_NL%LGP: '.true.'
                                NAEPHY:
                                        LEO3CH: '.true.'
                                NAERAD:
                                        LEPO3RA: '.true.' # use progn O3 in radiation
                                        LCMIP6O3: '.true.'
                                        NGHGRAD: 20       # overwrite O3 by progn O3

choose_restart_type:
        eternal:
                nfrres: 1
                nfrests:
                        - -1
                        - $(( -${simulation_length_seconds} / 3600 ))
                nrest_ind: ""
        ifs_default:
                nfrres: ${next_step}
                nfrests: ["-${next_step}"]
                nrest_ind: "(1)"

restart_type: "ifs_default"


##
## specifics for scenarios
##

# NOTE: We can only have one choose_mip
# Therefore, we must put choose_scenario under this choose_mip
# If one yaml file has two choose_mip, I think the code will only
# evaluate one of the branches
# NOTE 2: Im leaving CMIP5 in here, but I dont think we will ever use it

choose_mip:
        "cmip5":
                add_namelist_changes:
                        fort.4:
                                NAERAD:
                                        CMIP5DATADIR: "${cmip5_data_dir_nml}"
        "cmip6":
                add_namelist_changes:
                        fort.4:
                                NAERAD:
                                        LCMIP6: ".true."
                                        CMIP6DATADIR: "${cmip6_data_dir_nml}"
                choose_scenario:
                        "piControl":
                                add_namelist_changes:
                                        fort.4:
                                                NAERAD:
                                                        NCMIPFIXYR: 1850
                        "SSP5-8.5":
                                add_namelist_changes:
                                        fort.4:
                                                NAERAD:
                                                        SSPNAME: "SSP5-8.5"

#choose_o3_scheme:
#        "prescribed":
#                choose_mip:
#                        "cmip6":
#                                choose_scenario:
#                                        "piControl":
#                                                add_forcing_files:
#                                                        # O3 concentrations for piControl
#                                                        O3PI: O3PI
#                                        "historical":
#                                                add_forcing_files:
#                                                        # Add historical O3
#                                                        O3HIST: O3HIST
#                                        "SSP5-8.5":
#                                                add_forcing_files:
#                                                        # Add O3 for all scenarios
#                                                        O3SCEN: O3SCEN


#======================================================================================
# INPUT AND FORCING FILES
#======================================================================================

prepifs_dir: ${input_dir}/${prepifs_startdate}${hours}/
tl_o3_data_dir: ${input_dir}
ICMGG_INIT_name: ""
ICMSH_INIT_name: ""

input_sources:
        ICMGG_INIT: ${prepifs_dir}/ICMGG${prepifs_expid}INIT${ICMGG_INIT_name}
        ICMGG_INIUA: ${prepifs_dir}/ICMGG${prepifs_expid}INIUA
        ICMSH_INIT: ${prepifs_dir}/ICMSH${prepifs_expid}INIT${ICMSH_INIT_name}
        wam_grid_tables: ${prepifs_dir}/wam_grid_tables
        wam_subgrid_0: ${prepifs_dir}/wam_subgrid_0
        wam_subgrid_1: ${prepifs_dir}/wam_subgrid_1
        wam_subgrid_2: ${prepifs_dir}/wam_subgrid_2
        uwavein: ${prepifs_dir}/uwavein
        specwavein: ${prepifs_dir}/specwavein
        sfcwindin: ${prepifs_dir}/sfcwindin
        cdwavein: ${prepifs_dir}/cdwavein
        rtables: ${rtables_dir}/*
        vtables: ${vtables_dir}/*
        ifsdata: ${ifsdata_dir}/*
        tl_data: ${tl_o3_data_dir}/${res_number_tl}/*
        o3_data: ${tl_o3_data_dir}/${res_number_tl}/o3chem_l${nlev}/*

forcing_sources:
        # GHG data
        PRE2005_MIDYR_CONC: ${cmip5_data_dir}/PRE2005_MIDYR_CONC.txt
        RCP3PD_MIDYR_CONC: ${cmip5_data_dir}/RCP3PD_MIDYR_CONC.txt
        RCP45_MIDYR_CONC: ${cmip5_data_dir}/RCP45_MIDYR_CONC.txt
        RCP6_MIDYR_CONC: ${cmip5_data_dir}/RCP6_MIDYR_CONC.txt
        RCP85_MIDYR_CONC: ${cmip5_data_dir}/RCP85_MIDYR_CONC.txt
        # CMIP6
        CMIP6DATA: ${cmip6_data_dir}/*
        O3PI: ${cmip6_data_dir}/o3_pi/*
        O3HIST: ${cmip6_data_dir}/o3_histo/*
        O3SCEN: ${cmip6_data_dir}/o3_scenarios/*
        # ICMCL
        ICMCL_INIT: ${icmcl_dir}/${icmcl_file}


config_sources:
        "fort.4": "${namelist_dir}/fort.4"

input_in_work:
        ICMGG_INIT: ICMGG${oifs.input_expid}INIT
        ICMGG_INIUA: ICMGG${oifs.input_expid}INIUA
        ICMSH_INIT: ICMSH${oifs.input_expid}INIT
        ifs_xml: ifs_xml/*
        iodef_xml: iodef.xml
        context_xml: context_ifs.xml
        rtables: rtables/*
        vtables: vtables/*
        ifsdata: ifsdata/*
        tl_data: ${res_number_tl}/*
        o3_data: ${res_number_tl}/o3chem_l${nlev}/*

forcing_in_work:
        PRE2005_MIDYR_CONC: PRE2005_MIDYR_CONC.txt
        RCP3PD_MIDYR_CONC: RCP3PD_MIDYR_CONC.txt
        RCP45_MIDYR_CONC: RCP45_MIDYR_CONC.txt
        RCP6_MIDYR_CONC: RCP6_MIDYR_CONC.txt
        RCP85_MIDYR_CONC: RCP85_MIDYR_CONC.txt
        CMIP6DATA: cmip6_data/*
        O3PI: cmip6_data/o3_pi/*
        O3HIST: cmip6_data/o3_histo/*
        O3SCEN: cmip6_data/o3_scenarios/*
        ICMCL_INIT: ICMCL${oifs.input_expid}INIT


#======================================================================================
# GRIDS
#======================================================================================

# A grid at N80 resolution is A080 etc.
grids:
        atma:
                name: ${oasis_grid_name_a}
                nx: "${nx}"
                ny: "${ny}"
                oasis_grid_type: "D"
        atml:
                name: ${oasis_grid_name_l}
                nx: "${nx}"
                ny: "${ny}"
                oasis_grid_type: "D"
        atmr:
                name: ${oasis_grid_name_r}
                nx: "${nx}"
                ny: "${ny}"
                oasis_grid_type: "D"


#======================================================================================
# OUTPUT CONFIG
#======================================================================================

choose_output:
        "default":
                add_namelist_changes:
                        fort.4:
                                NAMCT0:
                                        NFRPOS: "$(( 3600 / ${time_step} * 6 ))"
                                        NFRHIS: "$(( 3600 / ${time_step} * 6 ))"

        "12hr":
                add_namelist_changes:
                        fort.4:
                                NAMCT0:
                                        NFRPOS: 12
                                        NFRHIS: 12
         
        "1hr":
                 add_namelist_changes:
                        fort.4:
                                NAMCT0:
                                        NFRPOS: "$(( 3600 / ${time_step} * 1 ))"
                                        NFRHIS: "$(( 3600 / ${time_step} * 1 ))"
#======================================================================================
# PREPROCESS: eternal runs
#======================================================================================
# @JOAKIM: please compare your preprocessing scripts with the new ones

# Determine the eternal_run_number variable. Normally this variable would be the same
# as general.run_number, but for branchoff experiments should be 0 so that the 3rd
# preprocessing option is used, instead of the options 1 or 2.
branchoff: false
eternal_run_number: "$((
        0 if (${lresume} and ${general.run_number} == 1)
            or (${general.run_number} == 2 and ${prev_run.oifs.branchoff})
        else ${general.run_number}
    ))"

# The following choose defines a pseudo_initial_date for OIFS. This allows us to trick
# OIFS into thinking that, from leg 3, it is always running a 2nd leg, avoiding the
# memory issues mentioned before. This is done by declaring the pseudo_initial_date
# as the last start date.
choose_eternal_run_number:
        1:
                pseudo_initial_date: "${initial_date}"
                start_ndays_source: "${start_ndays}"
                preprocess_method: "
                    ${general.esm_function_dir}/components/oifs/change_icm_date.sh
                        ${thisrun_input_dir}/
                        ${oifs.input_expid}
                        ${oifs.input_expid}
                        ${initial_date!syear!smonth!sday}
                        ${start_date!syear!smonth!sday}
                        ${oifs.wam_number}
                        ${oifs.perturb}
                        ${oifs.nx}
                        ${oifs.ensemble_id};
                    ${slice_icml}
                    ${append_icmcl}
                    echo 'Run number for internal OpenIFS timekeeping: ${eternal_run_number}'"
        2:
                pseudo_initial_date: "${prev_run.general.start_date}"
                start_ndays_source: "${start_ndays}"
                preprocess_method: "${general.esm_function_dir}/components/oifs/skip.sh;
                    ${slice_icml}
                    ${append_icmcl}
                    echo 'Run number for internal OpenIFS timekeeping: ${eternal_run_number}'"
        "*":
                pseudo_initial_date: "${prev_run.general.start_date}"
                start_ndays_source: "${prev_run.oifs.next_ndays}"
                preprocess_method: "
                    ${general.esm_function_dir}/components/oifs/change_icm_date.sh
                        ${thisrun_input_dir}/
                        ${oifs.input_expid}
                        ${oifs.input_expid}
                        ${pseudo_initial_date!syear!smonth!sday}
                        ${start_date!syear!smonth!sday}
                        ${oifs.wam_number}
                        ${oifs.perturb}
                        ${oifs.nx}
                        ${oifs.ensemble_id};
                    ${general.esm_function_dir}/components/oifs/change_rcf_date.sh
                        ${thisrun_restart_in_dir}/
                        ${pseudo_initial_date!syear!smonth!sday}
                        ${oifs.time_step}
                        ${oifs.seconds_since_initial}
                        ${oifs.start_ndays}
                        ${oifs.wam};
                    ${slice_icml}
                    ${append_icmcl}
                    echo 'Long OpenIFS run. Number for internal OpenIFS timekeeping: ${eternal_run_number}'"
                # If this is run 1 or 2 of an experiment, lable it as branchoff
                choose_eternal_run_number:
                        0:
                                branchoff: true


choose_general.standalone:
        True:
                slice_icml: "
                    ${general.esm_function_dir}/components/oifs/slice_icmcl_file.sh
                        ${thisrun_input_dir}/
                        ${icmcl_dir}/${icmcl_file}
                        ${oifs.input_expid}
                        ${start_date!syear!smonth!sday}
                        ${icmcl_end_date_formatted}
                        ${work_dir};"
        False:
                slice_icml: ""

append_icmcl: ""

preprocess:
        preprocess_shell:
                method: "${preprocess_method}"
                type: shell


#======================================================================================
# POSTPROCESS
#======================================================================================
# the postprocessing is at the moment essentially the same as the preprocessing plugin
# it just executes a shell script
# not working as expected as there is no "wait" after submit in the compute recipe below
postprocess:
        postprocess_shell:
                method: "${general.esm_function_dir}/components/oifs/oifs-43r3-postprocess.sh ${work_dir} ECE3 ${start_date!syear!smonth!sday} ${end_date!syear!smonth!sday}"
                type: shell


#======================================================================================
# RECIPE
#======================================================================================

prepcompute_recipe:
   - "compile_model"
   - "_show_simulation_info"
   - "create_new_files"
   - "create_empty_folders"
   - "prepare_coupler_files"
   - "assemble"
   - "log_used_files"
   - "_write_finalized_config"
   - "copy_files_to_thisrun"
   - "write_env"
   - "preprocess"
   - "modify_namelists"
   - "modify_files"
   - "copy_files_to_work"
   - "report_missing_files"
   # see https://github.com/esm-tools/esm_tools/discussions/774
   # - "add_vcs_info"
   #- "check_vcs_info_against_last_run"
   - "database_entry"
# this does not work as expected, solution is work in progress
#   - "postprocess"

