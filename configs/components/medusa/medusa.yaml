# MEDUSA-2.0 YAML CONFIGURATION FILE
#
model: medusa
branch: main
version: '2.0'
apps: 'medusa_recom_awiesm'

metadata:
        Institute: University Liege
        Description:
                MEDUSA is Model of Early Diagenesis in the Upper Sediment with Adatable complexity.
        Authors: Guy Munhoven
        Publications:
                - "Model of Early Diagenesis in the Upper Sediment with Adaptable complexity â€“ MEDUSA (v. 2): a time-dependent biogeochemical sediment module for Earth system models, process analysis
and teaching <https://doi.org/10.5194/gmd-14-3603-2021>"
        License:
                Please make sure you have a licence to use MEDUSA. In case you are unsure,
                please contact Guy Munhoven (guy.munhoven@uliege.be)

choose_version:
    '2.0':
      branch: main

git-repository: https://gitlab.dkrz.de/modular_esm/medusa2.git
# directory for code and libraries
model_dir: "${general.esm_master.dir}/medusa-${version}"
#lib_dir: "${model_dir}/lib"
#inc_dir: "${model_dir}/include"
#code_dir: "${model_dir}/medmbm/trunk4mcg"
# directory of applications
#setup_dir: "${model_dir}/medmbm/trunk4mcg/apps/medusa_recom_paleo"
# directory of executables
#bin_dir: "${model_dir}/work/exe_files"
# input data e.g. fesom.mesh.diag.nc needed for medusa
#data_path: ""

environment_changes:
        add_module_actions:
                - "unload netcdf"
                - "load netcdf/4.6.1_intel"

clean_command: ${defaults.clean_command}
comp_command: "mkdir -p lib; mkdir -p include;
    cd ${model_dir}/libthdyct/trunk; cp Makefile_mpiifort ./Makefile; make;
    mv libthdyct.a ${model_dir}/lib;
    cd ${model_dir}/muxml/trunk/src; cp Makefile_mpiifort ./Makefile;
    make libmodmxm.a; mv libmodmxm.a ${model_dir}/lib;
    cp modmxm.h *.mod ${model_dir}/include;
    cd ${model_dir}/medmbm/trunk4mcg/src-mcg; cp Makefile_mpiifort ./Makefile; make;
    cd ${model_dir}/medmbm/trunk4mcg/src-med; cp Makefile_mpiifort ./Makefile; make;
    make usetemplates;
    make libmedusa.a;
    cd ${model_dir}/medmbm/trunk4mcg/apps/medusa_recom_awiesm; make;"
#YY: compiler-dependent changes needed in Makefile -> choose_compiler/machine?
#now the _mpiifort ones copied during compilation
#original medusa code: include/ifort or mpiifort, lib/ifort or mpiifort created

install_bins: medmbm/trunk4mcg/work/medusa_recom_paleo
executable: medusa_recom_paleo
# exe saved in ${model_dir}/medmbm/trunk4mcg/work
# should be copied into medusa run directory

# Defaults
lresume: false
with_ciso: false
forcing_dir: ""
forcing_name: "fesom.ave"
namelist_dir: ${model_dir}/medmbm/trunk4mcg/nml/

# Input
variables:
    - Alk
    - DIC
    - DIN
    - DSi
    - O2
    - salt
    - temp

fluxes:
    - Calc
    - Opal
    - POC
    - PON

choose_with_ciso:
    add_variables:
        - DIC_13
        - DIC_14
    add_fluxes:
        - C13
        - C14
        - Cal13
        - Cal14

forcing_files:
    "[[variables-->VAR]]": "VAR"
    "[[fluxes-->FLX]]": "FLX"
forcing_sources:
    "[[variables-->VAR]]": "${forcing_dir}/VAR.${forcing_name}.${start_date!year}-${end_date!year}.nc"
    "[[fluxes-->FLX]]": "${forcing_dir}/sinkFLX.${forcing_name}.${start_date!year}-${end_date!year}.nc"

config_files:
    recom_paleo_files: recom_paleo_files
    recom_paleo_forcing: recom_paleo_forcing
    seafloor_init: seafloor_init
    rrp: rrp
    tsi: tsi
config_sources:
    recom_paleo_files: ${namelist_dir}/medusa_recom_paleo_files.nml
    recom_paleo_forcing: ${namelist_dir}/medusa_recom_paleo_forcing.nml
    seafloor_init: ${namelist_dir}/medusa_seafloor_init.nml
    rrp: ${namelist_dir}/medusa.rrp
    tsi: ${namelist_dir}/medusa.tsi

bin_sources:
    medusa: ${model_dir}/bin/${executable}

namelists:
    - medusa_recom_paleo_files.nml
    - medusa_recom_paleo_forcing.nml
    - medusa_seafloor_init.nml
    - medusa.rrp
    - medusa.tsi # medusa time step, will be changed after each medusa run (like 'fesom.clock')

namelist_changes:
    medusa_recom_paleo_files.nml:
        nml_cfg:
            cfn_ncin_init: 'medusa_reaclay_restart.nc'
            cfn_ncin_flx: 'medusa_flx_restart.nc'
            cfn_ncout_reaclay: 'medusa_reaclay.${start_date!year}.nc'
            cfn_ncout_reaction: 'medusa_reaction.${start_date!year}.nc'
            cfn_ncout_procrate: 'medusa_procrate.${start_date!year}.nc'
            cfn_ncout_bc: 'medusa_bc.${start_date!year}.nc'
            cfn_ncout_flx: 'medusa_flx.${start_date!year}.nc'
            cfn_ncout_fesom: 'medusa_flux2fesom.${start_date!year}.nc'
            #cfn_ncout_sedcore: 'medusa_sedcore.$year.nc'
    medusa_recom_paleo_forcing.nml:
        recom_file_list:
            cfn_[[variables-->VAL]]: VAL.${forcing_name}.${start_date!year}-${end_date!year}
            cfn_sink[[fluxes-->FLX]]: FLX.${forcing_name}.${start_date!year}-${end_date!year}

