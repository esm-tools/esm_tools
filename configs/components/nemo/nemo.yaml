# NEMO YAML CONFIGURATION FILE
#

# DEFAULT VALUES
model: nemo
generation: "3.6"
executable:     oceanx
version: GYRE_XIOS
reference_expid: EXP00 
include_models:
- xios

# compilation settings
# 
clean_command: cp cfg.inc ../cfg.txt; cd ../
   ./makenemo -n ${nemo.version} -m ${archfile} clean;
   rm -r ${nemo.version}/BLD;
   rm -r ../TOOLS/COMPILE/arch_nemo.fcm; 
   cd ..

comp_command: export NEMO_TOPLEVEL=${model_dir}/../../ ; cp cfg.inc ../cfg.txt ; cd ../ ;
  ./makenemo -n ${version} -m ${archfile} -j 24; cp -p ${version}/BLD/bin/nemo.exe
  ${version}/BLD/bin/oceanx ;
  cd ..

archfile: ESMTOOLS_generic_oasis_intel

destination: ${version}
install_bins: BLD/bin/oceanx

contact: "swahl(at)geomar.de"

#############################################################
# file handling settings
file_movements:
   default:
      all_directions: copy
   config:
      init_to_exp: copy
      exp_to_run: link
      run_to_work: link
   forcing:
      all_directions: link
   log:
      all_directions: copy
   input:
      all_directions: link
   outdata:
      all_directions: move 

runoff_method: "old"
#
# workaround for limitations in the environment_changes functionality
# see discussion at https://github.com/esm-tools/esm_tools/discussions/912
# 
#hlrn_compiler_mpi: intel2019_impi2019
#hlrn_iolibraries: geomar_libs
#environment_changes:
#  choose_computer.name:
#    glogin:
#      compiler_mpi: ${nemo.hlrn_compiler_mpi}
#      iolibraries: ${nemo.hlrn_iolibraries}
#    blogin:
#      compiler_mpi: ${nemo.hlrn_compiler_mpi}
#      iolibraries: ${nemo.hlrn_iolibraries}

available_versions:
- ORCA05_LIM2_KCM_AOW
- ORCA05_LIM2_KCM_AOW_autotools
- ORCA05_LIM2_KCM_AOW_FS
- ORCA05_LIM2_FOCI_AGRIF
- ORCA05_LIM2_FOCI_AGRIF_AOW
- ORCA05_LIM2_KCM_AGRIF_OASISMCT4
- ORCA05_LIM2_FOCI_MOPS_OASISMCT4
- ORCA05_LIM2_FOCI_AGRIF_MOPS_OASISMCT4
- ORCA05_LIM2_KCM_AOW_FS_OASISMCT4
- ORCA12_LIM2_KCM_AOW_FS_OASISMCT4
- ORCA05_LIM2_NEMO_JRA55_test
- GYRE_XIOS
- GYRE_PISCES
- 'ORCA05.z75.ICE.JRA' 
- eORCA025_Z75_SI3_JRA55 
- eORCA025_Z75_SI3_COUPLED
- ORCA05_Z46_SI3_COUPLED

choose_version:

  GYRE_XIOS:
    requires:
    - xios-2.5_r1910_ogcm
    - nemobasemodel-3.6ogcm_test
    archfile: ESMTOOLS_generic_intel
    resolution: R4

  GYRE_PISCES:

    # workaround for limitations in the environment_changes functionality
    # see discussion at https://github.com/esm-tools/esm_tools/discussions/912
    #hlrn_compiler_mpi: intel2019_impi2019_nemo4
    #hlrn_iolibraries: geomar_libs       
    environment_changes:
      choose_computer.name:
        blogin:
           add_module_actions:
             - "load gcc/9.3.0" 
        glogin:
           add_module_actions:
             - "load gcc/9.3.0" 

    requires:
    - xios-trunk
    - nemobasemodel-4.2.x

    # TODO: include arch repo as separate component
    comp_command: export NEMO_TOPLEVEL=${model_dir} ; export XIOS_TOPLEVEL=${model_dir}/../xios; 
                  test -d arch/GEOMAR || git clone https://git.geomar.de/foci/src/nemo_arch.git arch/GEOMAR;
                  ./makenemo -n ${version} -m ${archfile} -r ${version} -j 24 ; cp -p cfgs/${version}/BLD/bin/nemo.exe cfgs/${nemo.version}/BLD/bin/oceanx
    clean_command: ./makenemo -n ${nemo.version} -m ${archfile} -r ${nemo.version} clean
    archfile: ESMTOOLS_generic_intel
    destination: nemo-${nemo.version}
    install_bins: cfgs/${nemo.version}/BLD/bin/oceanx

    namelist_dir: ${nemo.model_dir}/cfgs/${nemo.version}/EXPREF/

    use_tracer: true 
    
    add_input_sources:
        namelist_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ref
        namelist_top_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_top_ref
        namelist_pisces_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_pisces_ref
        namelist_pisces_cfg: ${nemo.model_dir}/cfgs/${nemo.version}/EXPREF/namelist_pisces_cfg
    add_input_files:
       namelist_ref: namelist_ref
       namelist_top_ref: namelist_top_ref
       namelist_pisces_ref: namelist_pisces_ref
       namelist_pisces_cfg: namelist_pisces_cfg

    generation: "4.2"
    resolution: "R4"
  
  eORCA025_Z75_SI3_JRA55:
    # Uncoupled eORCA025 set up with SI3 sea ice model
    # developed and maintained by Markus
    # basis for our coupled setups with NEMO4.2

    # workaround for limitations in the environment_changes functionality
    # see discussion at https://github.com/esm-tools/esm_tools/discussions/912
    #hlrn_compiler_mpi: intel2019_impi2019_nemo4
    #hlrn_iolibraries: geomar_libs       
    environment_changes:
      choose_computer.name:
        blogin:
           add_module_actions:
             - "load gcc/9.3.0" 
        glogin:
           add_module_actions:
             - "load gcc/9.3.0" 

    requires:
    - xios-trunk
    - nemobasemodel-4.2.0

    branch: ${nemo.version}
    reference_expid: 'K000.spinup.eos80'
    clone_destination: nemo-${nemo.version}/cfgs/${nemo.version}
    git-repository: https://git.geomar.de/ORCA/e025/eorca025.z75.si3.git

    # TODO: include arch repo as separate component
    comp_command: export NEMO_TOPLEVEL=${model_dir} ; export XIOS_TOPLEVEL=${model_dir}/../xios; 
                  test -d arch/GEOMAR || git clone https://git.geomar.de/foci/src/nemo_arch.git arch/GEOMAR;
                  cp cfgs/${nemo.version}/work_cfgs.inc cfgs/ref_cfgs.txt;
                  ./makenemo -n ${version} -m ${archfile} -r ${version} -j 24 ; 
                  cp -p cfgs/${version}/BLD/bin/nemo.exe cfgs/${version}/BLD/bin/oceanx
    clean_command: ./makenemo -n ${nemo.version} -m ${archfile} -r ${nemo.version} clean
    archfile: ESMTOOLS_generic_intel
    destination: nemo-${nemo.version}
    install_bins: cfgs/${nemo.version}/BLD/bin/oceanx

    namelist_dir: ${nemo.model_dir}/cfgs/${nemo.version}/${reference_expid}/

    generation: "4.2"
    resolution: eORCA025
    use_tracer: false 
    leapyear: false  
    free_surface: nonlinear
    ln_tsd_tradmp: true
    # this sets nn_fsbc
    coupling_freq_in_steps: 1

    input_dir: ${pool_dir}/NEMO4_${resolution}/input
    # forcing for uncoupled setups
    jra55_forcing_dir: ${pool_dir}/JRA55-do_drowned
    jra55_runoff_dir: ${pool_dir}/eORCA025-nemo4

    # override hardcoded path to runoff forcing
    add_namelist_changes:
       namelist_cfg:
          namsbc_blk:
             cn_dir: "./"
    
    add_input_sources:
        namelist_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ref
        namelist_ice_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ice_ref
    add_input_files:
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref

       # NEMO eORCA025 4.2.x input files
       coordinates_eORCA025: coordinates_eORCA025 
       bfr_coef_eORCA025: bfr_coef_eORCA025
       subbasins_eORCA025: subbasins_eORCA025
       domain_cfg_eORCA025: domain_cfg_eORCA025
       # this file still needs to be generated by Markus or us
       #domain_cfg_eORCA025: domain_cfg_eORCA025_CaspianSea
       # we probably never need this one
       domain_cfg_UKmasks: domain_cfg_UKmasks 

       ghflux_v2.0: ghflux_v2.0
       reshape_ghflux2_eORCA025: reshape_ghflux2_eORCA025
       reshape_jra55do_eORCA025_bicub: reshape_jra55do_eORCA025_bicub
       reshape_jra55do_eORCA025_bilin: reshape_jra55do_eORCA025_bilin

       # inital data
       data_tem_eORCA025: data_tem_eORCA025
       data_sal_eORCA025: data_sal_eORCA025
       runoff_eORCA025: runoff_eORCA025
       seaice_eORCA025: seaice_eORCA025

    input_in_work:
       # NEMO eORCA025 4.2.x input files
       domain_cfg_eORCA025: domain_cfg.nc
       coordinates_orca05_nemo4: coordinates.nc
       bfr_coef_eORCA025: bfr_coef.nc
       subbasins_eORCA025: subbasins.nc
      
       # inital data
       data_tem_eORCA025: data_tem.nc
       data_sal_eORCA025: data_sal.nc
       ghflux_v2.0: geothermal_heating.nc
       
    # surface forcing for uncoupled NEMO4
    forcing_files:
      # forcing data
      sn_wndi: sn_wndi
      sn_wndj: sn_wndj
      sn_qsr: sn_qsr
      sn_qlw: sn_qlw
      sn_tair: sn_tair
      sn_humi: sn_humi
      sn_prec: sn_prec
      sn_snow: sn_snow
      sn_slp: sn_slp
      #sn_rnf: sn_rnf

    # only required if we need the link name does not match the source file name
    forcing_in_work:
        sn_wndi: "uas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_wndj: "vas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_qsr: "rsds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_qlw: "rlds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_tair: "tas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_humi: "huss-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_prec: "prra_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_snow: "prsn_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        sn_slp: "psl_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc"
        #sn_rnf: "sorunoff_JRA55-do-1-4-0_gr_orca05_y@YEAR@.nc"

    forcing_sources:
        # JRA55-do drowned forcing
        sn_wndi:
          "${jra55_forcing_dir}/uas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_wndj:
          "${jra55_forcing_dir}/vas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_qsr:
          "${jra55_forcing_dir}/rsds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_qlw:
          "${jra55_forcing_dir}/rlds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_tair:
          "${jra55_forcing_dir}/tas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_humi:
          "${jra55_forcing_dir}/huss-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_prec:
          "${jra55_forcing_dir}/prra_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_snow:
          "${jra55_forcing_dir}/prsn_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_slp:
          "${jra55_forcing_dir}/psl_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 2019
        sn_rnf:
          "${jra55_runoff_dir}/sorunoff_JRA55-do-1-5-0_gr_eorca025_y@YEAR@.nc":
             from: 1958
             to: 2019

  'eORCA025_Z75_SI3_COUPLED':
    # coupled eORCA025 set up with SI3 sea ice model

    # modifications to compile time and runtime environment changes
    # are set in components/setups/focioifs.yaml

    requires:
    - nemobasemodel-4.2.0

    branch: ${nemo.version}
    reference_expid: 'FOCIOIFS'
    clone_destination: nemo-${nemo.version}/cfgs/${nemo.version}
    git-repository: https://git.geomar.de/ORCA/e025/eorca025.z75.si3.git

    # TODO: include arch repo as separate component
    comp_command: export NEMO_TOPLEVEL=${model_dir} ; export XIOS_TOPLEVEL=${model_dir}/../xios; 
                  test -d arch/GEOMAR || git clone https://git.geomar.de/foci/src/nemo_arch.git arch/GEOMAR;
                  cp cfgs/${nemo.version}/work_cfgs.inc cfgs/ref_cfgs.txt;
                  ./makenemo -n ${version} -m ${archfile} -r ${version} -j 24 ; 
                  cp -p cfgs/${version}/BLD/bin/nemo.exe cfgs/${version}/BLD/bin/oceanx
    clean_command: ./makenemo -n ${nemo.version} -m ${archfile} -r ${nemo.version} clean
    archfile: ESMTOOLS_generic_oasis_intel
    destination: nemo-${nemo.version}
    install_bins: cfgs/${nemo.version}/BLD/bin/oceanx

    namelist_dir: ${nemo.model_dir}/cfgs/${nemo.version}/${reference_expid}/

    generation: "4.2"
    resolution: eORCA025
    use_tracer: false 
    leapyear: false  
    free_surface: nonlinear

    # coupling fields differ for NEMO 3.6 and 4.2
    opat_fields: [O_AlbIce, OIceFrc, O_SSTSST, O_TepIce, OIceTck, OSnwTck, O_OCurx1, O_OCury1, O_OTaux1, O_OTauy1, O_ITaux1, O_ITauy1]

    input_dir: ${pool_dir}/NEMO4_${resolution}/input

    # override hardcoded path to runoff forcing
    add_namelist_changes:
       namelist_cfg:
          namsbc_blk:
             cn_dir: "./"
          #namrun:
          #    nn_write: 3 # hourly output (no xios used)
          namsbc:
             ln_blk: false
             ln_cpl: true
             ln_ssr: false
             ln_rnf: false
             ln_traqsr: false
             ln_apr_dyn: false
          namsbc_cpl:
             sn_snd_temp: ['oce and ice', 'no', '', '', '']
             sn_snd_alb: ['ice', 'no', '', '', '']
             sn_snd_thick: ['ice and snow', 'no', '', '', '']
             sn_snd_crt: ['oce only', 'no', 'spherical', 'eastward-northward', 'T']
             sn_snd_co2: ['none', 'no', '', '', '']
             sn_snd_cond: ['none', 'no', '', '', '']
             sn_snd_mpnd: ['none', 'no', '', '', '']
             sn_snd_sstfrz: ['none','no','','','']
             sn_snd_wlev: ['none','no','','','']
             sn_snd_ttilyr: ['none','no','','','']
             sn_rcv_w10m: ['none', 'no', '', '', '']
             sn_rcv_taumod: ['none', 'no', '', '', '']
             sn_rcv_tau: ['oce and ice', 'no', 'spherical', 'eastward-northward', 'T']
             sn_rcv_dqnsdt: ['coupled', 'no', '', '', '']
             sn_rcv_qsr: ['conservative', 'no', '', '', '']
             sn_rcv_qns: ['conservative', 'no', '', '', '']
             sn_rcv_emp: ['conservative', 'no', '', '', '']
             sn_rcv_rnf: ['coupled', 'no', '', '', '']
             sn_rcv_cal: ['coupled', 'no', '', '', '']
             sn_rcv_co2: ['none', 'no', '', '', ''] 
   #       namtra_ldf:
   #          rn_aht_0: 600
   #          rn_aeiv_scale: 0.5
   #       namdyn_ldf:
   #          rn_cmsmag_2: 4
   #       namsbc_rnf:
   #          rn_rfact: 0.984

    add_input_sources:
        namelist_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ref
        namelist_ice_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ice_ref

    add_input_files:
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref

       # NEMO eORCA025 4.2.x input files
       coordinates_eORCA025: coordinates_eORCA025 
       bfr_coef_eORCA025: bfr_coef_eORCA025
       subbasins_eORCA025: subbasins_eORCA025
       domain_cfg_eORCA025: domain_cfg_eORCA025
       # this file still needs to be generated by Markus or us
       #domain_cfg_eORCA025: domain_cfg_eORCA025_CaspianSea
       # we probably never need this one
       domain_cfg_UKmasks: domain_cfg_UKmasks 

       ghflux_v2.0: ghflux_v2.0
       reshape_ghflux2_eORCA025: reshape_ghflux2_eORCA025

       # inital data
       data_tem_eORCA025: data_tem_eORCA025
       data_sal_eORCA025: data_sal_eORCA025
       runoff_eORCA025: runoff_eORCA025
       seaice_eORCA025: seaice_eORCA025

    input_in_work:
       # NEMO eORCA025 4.2.x input files
       domain_cfg_eORCA025: domain_cfg.nc
       coordinates_orca05_nemo4: coordinates.nc
       bfr_coef_eORCA025: bfr_coef.nc
       subbasins_eORCA025: subbasins.nc
      
       # inital data
       data_tem_eORCA025: data_tem.nc
       data_sal_eORCA025: data_sal.nc
       ghflux_v2.0: geothermal_heating.nc
       
  'ORCA05.z75.ICE.JRA': 
    # uncoupled test setup from Markus
    # will be renamed once the name of the config is available
    # from Markus Scheinert
    # version: 'ORCA05.z75.ICE.JRA-KMST001'

    # workaround for limitations in the environment_changes functionality
    # see discussion at https://github.com/esm-tools/esm_tools/discussions/912
    #hlrn_compiler_mpi: intel2019_impi2019_nemo4
    #hlrn_iolibraries: geomar_libs       
    environment_changes:
      choose_computer.name:
        blogin:
           add_module_actions:
             - "load gcc/9.3.0" 
        glogin:
           add_module_actions:
             - "load gcc/9.3.0" 

    requires:
    - xios-trunk
    - nemobasemodel-4.2.0

    branch: esm-tools_v4.2.0 
    reference_expid: KSWT001
    clone_destination: nemo-${nemo.version}/cfgs/${nemo.version}
    git-repository: https://git.geomar.de/mscheinert/${nemo.version}-KMST001.git 

    # TODO: include arch repo as separate component
    comp_command: export NEMO_TOPLEVEL=${model_dir} ; export XIOS_TOPLEVEL=${model_dir}/../xios; 
                  test -d arch/GEOMAR || git clone https://git.geomar.de/foci/src/nemo_arch.git arch/GEOMAR;
                  cp cfgs/${nemo.version}/work_cfgs.inc cfgs/ref_cfgs.txt;
                  ./makenemo -n ${version} -m ${archfile} -r ${version} -j 24 ; 
                  cp -p cfgs/${version}/BLD/bin/nemo.exe cfgs/${version}/BLD/bin/oceanx
    clean_command: ./makenemo -n ${nemo.version} -m ${archfile} -r ${nemo.version} clean  
    archfile: ESMTOOLS_generic_intel
    destination: nemo-${nemo.version}
    install_bins: cfgs/${nemo.version}/BLD/bin/oceanx

    namelist_dir: ${nemo.model_dir}/cfgs/${nemo.version}/${reference_expid}/

    generation: "4.2"
    resolution: ORCA05
    use_tracer: false 
    leapyear: false  
    free_surface: nonlinear
    input_dir: ${pool_dir}/NEMO4_${resolution}/input

    # override hardcoded path to runoff forcing
    add_namelist_changes:
       namelist_cfg:
          namsbc_blk:
             cn_dir: "./"
          namsbc_apr:
             cn_dir: "./"
          namsbc_rnf:
             cn_dir: "./"
    
    add_input_sources:
        namelist_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ref
        namelist_ice_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ice_ref
    add_input_files:
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref

       # NEMO ORCA05 4.2.x input files
       bathy_meter_orca05_nemo4: bathy_meter_orca05_nemo4
       coordinates_orca05_nemo4: bathy_meter_orca05_nemo4 
       bfr_coef_orca05_nemo4: bfr_coef_orca05_nemo4
       subbasins_orca05_nemo4: subbasins_orca05_nemo4
       domain_cfg_orca05_nemo4: domain_cfg_orca05_nemo4
      
       reshape_jra_orca05_nemo4_bicub: reshape_jra_orca05_nemo4_bicub
       reshape_jra_orca05_nemo4_bilin: reshape_jra_orca05_nemo4_bilin

       # inital data
       data_tem_orca05_nemo4: data_tem_orca05_nemo4
       data_sal_orca05_nemo4: data_sal_orca05_nemo4
       sss_orca05_nemo4: sss_orca05_nemo4
       runoff_orca05_nemo4: runoff_orca05_nemo4

    # TODO: add correct links in work dir if required
    input_in_work:
       # NEMO ORCA05 4.2.x input files
       bathy_meter_orca05_nemo4: bathy_meter.nc 
       coordinates_orca05_nemo4: coordinates.nc
       coef-G70: bfr_coef.nc
       bfr_coef_orca05_nemo4: bfr_coef.nc 
       subbasins_orca05_nemo4: subbasins.nc
       #domain_cfg_orca05_nemo4: domain_cfg__ORCA05_zps_noclo.nc
      
       #reshape_jra_orca05_nemo4_bicub: 
       #reshape_jra_orca05_nemo4_bilin: 

       # inital data
       data_tem_orca05_nemo4: data_tem.nc
       data_sal_orca05_nemo4: data_sal.nc
       sss_orca05_nemo4: SSS.nc 
       runoff_orca05_nemo4: RUNOFF.nc
    
    # surface forcing for uncoupled NEMO4
    forcing_files:
      # forcing data
      sn_wndi: sn_wndi
      sn_wndj: sn_wndj
      sn_qsr: sn_qsr
      sn_qlw: sn_qlw
      sn_tair: sn_tair
      sn_humi: sn_humi
      sn_prec: sn_prec
      sn_snow: sn_snow
      #sn_rnf: sn_rnf

    forcing_in_work:
        sn_wndi: "uas-drowned_JRA55do-1.5.0_y@YEAR@.nc"
        sn_wndj: "vas-drowned_JRA55do-1.5.0_y@YEAR@.nc"
        sn_qsr: "rsds-drowned_JRA55do-1.5.0_y@YEAR@.nc"
        sn_qlw: "rlds-drowned_JRA55do-1.5.0_y@YEAR@.nc"
        sn_tair: "tas-drowned_JRA55do-1.5.0_y@YEAR@.nc"
        sn_humi: "huss-drowned_JRA55do-1.5.0_y@YEAR@.nc"
        sn_prec: "prra_JRA55do-1.5.0_y@YEAR@.nc"
        sn_snow: "prsn_JRA55do-1.5.0_y@YEAR@.nc"
        #sn_rnf: "sorunoff_JRA55-do-1-4-0_gr_orca05_y@YEAR@.nc"

    forcing_sources:
        # JRA55-do drowned forcing
        sn_wndi:
          "${jra55_forcing_dir}/uas-drowned_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        sn_wndj:
          "${jra55_forcing_dir}/vas-drowned_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        sn_qsr:
          "${jra55_forcing_dir}/rsds-drowned_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        sn_qlw:
          "${jra55_forcing_dir}/rlds-drowned_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        sn_tair:
          "${jra55_forcing_dir}/tas-drowned_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        sn_humi:
          "${jra55_forcing_dir}/huss-drowned_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        sn_prec:
          "${jra55_forcing_dir}/prra_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        sn_snow:
          "${jra55_forcing_dir}/prsn_JRA55do-1.5.0_y@YEAR@.nc":
             from: 1980
             to: 1984
        #sn_rnf:
        #  "${jra55_runoff_dir}/sorunoff_JRA55-do-1-4-0_gr_orca05_y@YEAR@.nc":
        #     from: 1980
        #     to: 1984
        
  ORCA05_Z46_SI3_COUPLED:
    # coupled ORCA05 set up with SI3 sea ice model

    # modifications to compile time and runtime environment changes
    # are set in components/setups/focioifs.yaml

    requires:
    - nemobasemodel-4.2.0

    branch: master
    reference_expid: 'FOCIOIFS'
    clone_destination: nemo-${nemo.version}/cfgs/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/orca05_z46_si3_coupled.git
    
    # TODO: include arch repo as separate component
    comp_command: export NEMO_TOPLEVEL=${model_dir} ; export XIOS_TOPLEVEL=${model_dir}/../xios; 
                  test -d arch/GEOMAR || git clone https://git.geomar.de/foci/src/nemo_arch.git arch/GEOMAR;
                  cp cfgs/${nemo.version}/work_cfgs.inc cfgs/ref_cfgs.txt;
                  ./makenemo -n ${version} -m ${archfile} -r ${version} -j 24 ; 
                  cp -p cfgs/${version}/BLD/bin/nemo.exe cfgs/${version}/BLD/bin/oceanx
    clean_command: ./makenemo -n ${nemo.version} -m ${archfile} -r ${nemo.version} clean
    archfile: ESMTOOLS_generic_oasis_intel
    destination: nemo-${nemo.version}
    install_bins: cfgs/${nemo.version}/BLD/bin/oceanx

    namelist_dir: ${nemo.model_dir}/cfgs/${nemo.version}/${reference_expid}/

    generation: "4.2"
    resolution: ORCA05
    use_tracer: false 
    leapyear: false  
    free_surface: nonlinear

    input_dir: ${pool_dir}/NEMO4_${resolution}/input

    # override hardcoded path to runoff forcing
    add_namelist_changes:
       namelist_cfg:
          namsbc_blk:
             cn_dir: "./"
          #namrun:
          #    nn_write: 3 # hourly output (no xios used)
          namsbc:
             ln_blk: false
             ln_cpl: true
             ln_ssr: false
             ln_rnf: false
             ln_traqsr: false
             ln_apr_dyn: false
          namsbc_cpl:
             sn_snd_temp: ['oce and ice', 'no', '', '', '']
             sn_snd_alb: ['ice', 'no', '', '', '']
             sn_snd_thick: ['ice and snow', 'no', '', '', '']
             sn_snd_crt: ['oce only', 'no', 'spherical', 'eastward-northward', 'T']
             sn_snd_co2: ['none', 'no', '', '', '']
             sn_snd_cond: ['none', 'no', '', '', '']
             sn_snd_mpnd: ['none', 'no', '', '', '']
             sn_snd_sstfrz: ['none','no','','','']
             sn_snd_wlev: ['none','no','','','']
             sn_snd_ttilyr: ['none','no','','','']
             sn_rcv_w10m: ['none', 'no', '', '', '']
             sn_rcv_taumod: ['none', 'no', '', '', '']
             sn_rcv_tau: ['oce and ice', 'no', 'spherical', 'eastward-northward', 'T']
             sn_rcv_dqnsdt: ['coupled', 'no', '', '', '']
             sn_rcv_qsr: ['conservative', 'no', '', '', '']
             sn_rcv_qns: ['conservative', 'no', '', '', '']
             sn_rcv_emp: ['conservative', 'no', '', '', '']
             sn_rcv_rnf: ['coupled', 'no', '', '', '']
             sn_rcv_cal: ['coupled', 'no', '', '', '']
             sn_rcv_co2: ['none', 'no', '', '', ''] 
          nambbc:
             # Unlike default, we use geothermal heating remapped to ORCA05
             # No need for a reshape file
             sn_qgh: ['geothermal_heating.nc', -12.0, 'gh_flux', .false., .true., 'yearly', '', '']

          # set diffusion to be 600 m2/s
          # and visc to be -1,709 m4/s
          # A = Ud * Ld / 2. Ud = 0.024 gives approx A=600 m2/s for Ld=50km. 
          # A = Uv * Lv / 12. Uv = 0.164 gives around A=-1,709 m4/s for Ld=50km
          namtra_ldf:
             rn_ud: 0.024
          namdyn_ldf:
             rn_uv: 0.164
   
    add_input_sources:
        namelist_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ref
        namelist_ice_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ice_ref

    add_input_files:
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       
       # from Sebastian / Markus
       bathy_meter_orca05_nemo4: bathy_meter_orca05_nemo4
       coordinates_orca05_nemo4: bathy_meter_orca05_nemo4 
       bfr_coef_orca05_nemo4: bfr_coef_orca05_nemo4
       subbasins_orca05_nemo4: subbasins_orca05_nemo4
       domain_cfg_orca05_nemo4: domain_cfg_orca05_nemo4
       
       # NEMO ORCA05 4.2.x input files
       #coordinates_orca05_nemo4: coordinates_orca05_nemo4
       #bfr_coef_orca05_nemo4: bfr_coef_orca05_nemo4
       #subbasins_orca05_nemo4: subbasins_orca05_nemo4
       #domain_cfg_orca05_nemo4: domain_cfg_orca05_nemo4
       # we probably never need this one
       #domain_cfg_UKmasks: domain_cfg_UKmasks 
       # ghflux remapped to ORCA05, no reshape file needed
       ghflux_v2.0_orca05_nemo4: ghflux_v2.0_orca05_nemo4
       
       # inital data
       data_tem_orca05_nemo4: data_tem_orca05_nemo4
       data_sal_orca05_nemo4: data_sal_orca05_nemo4
       
       # inital data
       seaice_orca05_nemo4: seaice_orca05_nemo4

    input_in_work:
       domain_cfg_orca05_nemo4: domain_cfg.nc
       coordinates_orca05_nemo4: coordinates.nc
       bfr_coef_orca05_nemo4: bfr_coef.nc
       subbasins_orca05_nemo4: subbasins.nc
      
       # inital data
       data_tem_orca05_nemo4: data_tem.nc
       data_sal_orca05_nemo4: data_sal.nc
       ghflux_v2.0_orca05_nemo4: geothermal_heating.nc
       
       seaice_orca05_nemo4: seaice_c3.0_v19802004.0_ORCA05_r4.2.0.nc 

  ORCA05_LIM2_FOCI_AGRIF:
    requires:
    # seb-wahl: comment xios below if used with OIFS which also uses XIOS which causes XIOS
    # to be cloned and compiled twice, need to file an issue
    - xios-2.0_r982
    # TODO: test with newer version of XIOS
    # - xios-2.5_r1910
    - nemobasemodel-3.6foci_agrif
    branch: master 
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git
    archfile: ESMTOOLS_generic_oasis_intel_agrif

    # use tracer in AGRIF?
    use_tracer: false
    use_tracer_agrif: false 
    # use LIM2 in AGRIF?
    use_lim2_agrif: true
    free_surface: linear
    leapyear: true  

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h
       1_sn_tem_levitus: 1_sn_tem_levitus 
       1_sn_sal_levitus: 1_sn_sal_levitus 
       1_ice_init: 1_ice_init
       # reference namelists
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       # grids and coefficients 
       # batmeter: bathy_meter
       cn_batmeter: bathy_updated
       1_cn_batmeter: 1_bathy_meter
       1_coordinates: 1_coordinates
       fixed_grids: fixed_grids
       # reshape files for nest
       1_reshape_bicub: 1_reshape_bicub 
       1_reshape_bilin: 1_reshape_bilin 

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       1_coordinates: 1_coordinates_ORCA05.nc

    add_config_files:
       1_namelist_cfg: 1_namelist_cfg
       1_namelist_ice_cfg: 1_namelist_ice_cfg

    add_namelist_changes:
       1_namelist_cfg:
          namrun:
             cn_exp: ${expid}
             nn_it000: ${thisstep_nest}
             nn_itend: ${newstep_nest}
             nn_date0: ${initial_date!syear!smonth!sday} # ${ini_date}
             cn_ocerst_in: ${parent_expid}_${prevstep_formatted_nest}_restart_${parent_date!syear!smonth!sday}${global_tag} 
             cn_ocerst_indir: '${parent_restart_dir}/'
             cn_ocerst_out: restart_${end_date_m1!syear!smonth!sday}
             cn_ocerst_outdir: '${experiment_restart_out_dir}/'
             nn_stock: ${newstep_nest}
             nn_leapy: ${nn_leapy} 
             nn_rstctl: ${nn_rstctl} 
             ln_rstart: ${nemo.lresume}
          namtsd:                                                
             ln_tsd_tradmp: ${ln_tsd_tradmp} 
             ln_tsd_init: ${ln_tsd_init} 
          namdom:
             nn_closea: 1
             nn_msh: ${nn_msh} 
             rn_rdt: ${time_step_nest}
          namsbc:
             nn_fsbc: ${nest_refinement} 
             ln_echam: '.true.'
          nammpp:
             jpni: ${jpni}
             jpnj: ${jpnj}
             jpnij: ${nproc}
          namsbc_echam:
             sn_owndi: ['A_OTaux1_echam6_08', 3, 'A_OTaux1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Uwnd', ' ']
             sn_owndj: ['A_OTauy1_echam6_09', 3, 'A_OTauy1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Vwnd', ' ']
             sn_iwndi: ['A_ITaux1_echam6_10', 3, 'A_ITaux1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Uwnd', ' ']
             sn_iwndj: ['A_ITauy1_echam6_11', 3, 'A_ITauy1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Vwnd', ' ']
             sn_iqsr: ['A_QsrIce_echam6_12', 3, 'A_QsrIce', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_qsr: ['A_QsrMix_echam6_13', 3, 'A_QsrMix', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_iqns: ['A_QnsIce_echam6_14', 3, 'A_QnsIce', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', '', ' ']
             sn_qns: ['A_QnsMix_echam6_15', 3, 'A_QnsMix', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', '', ' ']
             sn_prec: ['ATotRain_echam6_16', 3, 'ATotRain', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_snow: ['ATotSnow_echam6_17', 3, 'ATotSnow', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_ievp: ['AIceEvap_echam6_18', 3, 'AIceEvap', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_dqns: ['A_dQnsdT_echam6_19', 3, 'A_dQnsdT', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
         
          # with AGRIF always use linear free surface
          # always set free_surface: linear with AGRIF 
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'
       namelist_cfg:
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'
    
  ORCA05_LIM2_FOCI_AGRIF_AOW:
    requires:
    # seb-wahl: comment xios below if used with OIFS which also uses XIOS which causes XIOS
    # to be cloned and compiled twice, need to file an issue
    - xios-2.0_r982
    # TODO: test with newer version of XIOS
    # - xios-2.5_r1910
    - nemobasemodel-3.6foci_agrif
    branch: master 
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git
    archfile: ESMTOOLS_generic_oasis_intel_agrif

    # use tracer in AGRIF?
    use_tracer_agrif: true
    # use LIM2 in AGRIF?
    use_lim2_agrif: true
    free_surface: linear
    leapyear: true  

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h
       1_sn_tem_levitus: 1_sn_tem_levitus 
       1_sn_sal_levitus: 1_sn_sal_levitus 
       1_ice_init: 1_ice_init
       # reference namelists
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       1_namelist_top_ref: 1_namelist_top_ref
       # grids and coefficients 
       # batmeter: bathy_meter
       cn_batmeter: bathy_updated
       1_cn_batmeter: 1_bathy_meter
       1_coordinates: 1_coordinates
       fixed_grids: fixed_grids
       # reshape files for nest
       1_reshape_bicub: 1_reshape_bicub 
       1_reshape_bilin: 1_reshape_bilin 

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       1_namelist_top_ref: 1_namelist_top_ref
       1_coordinates: 1_coordinates_ORCA05.nc

    add_config_files:
       1_namelist_cfg: 1_namelist_cfg
       1_namelist_ice_cfg: 1_namelist_ice_cfg
       1_namelist_top_cfg: 1_namelist_top_cfg

    add_namelist_changes:
       1_namelist_cfg:
          namrun:
             cn_exp: ${expid}
             nn_it000: ${thisstep_nest}
             nn_itend: ${newstep_nest}
             nn_date0: ${initial_date!syear!smonth!sday} # ${ini_date}
             cn_ocerst_in: ${parent_expid}_${prevstep_formatted_nest}_restart_${parent_date!syear!smonth!sday}${global_tag} 
             cn_ocerst_indir: '${parent_restart_dir}/'
             cn_ocerst_out: restart_${end_date_m1!syear!smonth!sday}
             cn_ocerst_outdir: '${experiment_restart_out_dir}/'
             nn_stock: ${newstep_nest}
             nn_leapy: ${nn_leapy} 
             nn_rstctl: ${nn_rstctl} 
             ln_rstart: ${nemo.lresume}
          namtsd:                                                
             ln_tsd_tradmp: ${ln_tsd_tradmp} 
             ln_tsd_init: ${ln_tsd_init} 
          namdom:
             nn_closea: 1
             nn_msh: ${nn_msh} 
             rn_rdt: ${time_step_nest}
          namsbc:
             nn_fsbc: ${nest_refinement} 
             ln_echam: '.true.'
          nammpp:
             jpni: ${jpni}
             jpnj: ${jpnj}
             jpnij: ${nproc}
          namsbc_echam:
             sn_owndi: ['A_OTaux1_echam6_08', 3, 'A_OTaux1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Uwnd', ' ']
             sn_owndj: ['A_OTauy1_echam6_09', 3, 'A_OTauy1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Vwnd', ' ']
             sn_iwndi: ['A_ITaux1_echam6_10', 3, 'A_ITaux1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Uwnd', ' ']
             sn_iwndj: ['A_ITauy1_echam6_11', 3, 'A_ITauy1', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', 'Vwnd', ' ']
             sn_iqsr: ['A_QsrIce_echam6_12', 3, 'A_QsrIce', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_qsr: ['A_QsrMix_echam6_13', 3, 'A_QsrMix', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_iqns: ['A_QnsIce_echam6_14', 3, 'A_QnsIce', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', '', ' ']
             sn_qns: ['A_QnsMix_echam6_15', 3, 'A_QnsMix', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bicub.nc', '', ' ']
             sn_prec: ['ATotRain_echam6_16', 3, 'ATotRain', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_snow: ['ATotSnow_echam6_17', 3, 'ATotSnow', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_ievp: ['AIceEvap_echam6_18', 3, 'AIceEvap', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
             sn_dqns: ['A_dQnsdT_echam6_19', 3, 'A_dQnsdT', .false., .false., 'instant', 'reshape_T63invert_${nest1}_bilin.nc', '', ' ']
         
          # with AGRIF always use linear free surface
          # always set free_surface: linear with AGRIF 
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'
       namelist_cfg:
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'

  ORCA05_LIM2_KCM_AGRIF_OASISMCT4:
    requires:
    # seb-wahl: workaround if used with OIFS which also uses XIOS which causes XIOS
    # to be cloned and compiled twice, need to file an issue
    #- xios-2.5_r1910
    - nemobasemodel-3.6foci
    branch: esm-tools
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git
    archfile: ESMTOOLS_generic_oasis_intel_agrif
    
    # use tracer in AGRIF?
    use_tracer_agrif: true
    # use LIM2 in AGRIF?
    use_lim2_agrif: true
    free_surface: linear
    leapyear: true  
    
    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h
       1_sn_tem_levitus: 1_sn_tem_levitus
       1_sn_sal_levitus: 1_sn_sal_levitus
       1_ice_init: 1_ice_init
       # reference namelists
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       1_namelist_top_ref: 1_namelist_top_ref
       # grids and coefficients
       cn_batmeter: bathy_updated
       1_cn_batmeter: 1_bathy_meter
       1_coordinates: 1_coordinates
       fixed_grids: fixed_grids
       # reshape files for nest
       1_reshape_bicub: 1_reshape_bicub
       1_reshape_bilin: 1_reshape_bilin

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       1_namelist_top_ref: 1_namelist_top_ref
       1_coordinates: 1_coordinates_ORCA05.nc
    
    add_config_files:
       1_namelist_cfg: 1_namelist_cfg
       1_namelist_ice_cfg: 1_namelist_ice_cfg
       1_namelist_top_cfg: 1_namelist_top_cfg

    add_namelist_changes:
       1_namelist_cfg:
          namrun:
             cn_exp: ${expid}
             nn_it000: ${thisstep_nest}
             nn_itend: ${newstep_nest}
             nn_date0: ${initial_date!syear!smonth!sday} # ${ini_date}
             cn_ocerst_in: ${parent_expid}_${prevstep_formatted_nest}_restart_${parent_date!syear!smonth!sday}${global_tag}
             cn_ocerst_indir: '${parent_restart_dir}/'
             cn_ocerst_out: restart_${end_date_m1!syear!smonth!sday}
             cn_ocerst_outdir: '${experiment_restart_out_dir}/'
             nn_stock: ${newstep_nest}
             nn_leapy: ${nn_leapy}
             nn_rstctl: ${nn_rstctl}
             ln_rstart: ${nemo.lresume}
          #namcfg:
          #   jpidta: ${_nx_nest1}
          #   jpjdta: ${_ny_nest1}
          #   jpiglo: ${_nx_nest1}
          #   jpjglo: ${_ny_nest1}
          namlbc: 
             rn_shlat: 2
             ln_vorlat: '.false.'
          namagrif:
             #nn_cln_update: 3
             rn_sponge_tra: 600 
             rn_sponge_dyn: 600 
          namtsd:
             ln_tsd_tradmp: ${ln_tsd_tradmp}
             ln_tsd_init: ${ln_tsd_init}
          namdom:
             nn_closea: 1
             nn_msh: ${nn_msh}
             rn_rdt: ${time_step_nest}
          namsbc:
             nn_fsbc: 3
             nn_ice: 2
             ln_echam: '.false.'
             ln_cpl: '.true.'
          namtra_ldf: 
             rn_aeiv_0: 0.
             rn_aht_0: 120.
             rn_aht_m: 120.
          namdyn_ldf:
             rn_ahm_0_blp: -2.4e10
             rn_ahm_m_blp: -8.e9
             rn_ahm_m_lap: 0.
          nammpp:
             jpni: ${jpni}
             jpnj: ${jpnj}
             jpnij: ${nproc}
          #namnc4:
          #   ln_nc4zip: '.false.'
          #   nn_nchunks_i: 4
          #   nn_nchunks_j: 4
          #   nn_nchunks_k: 4
          nambbl:
             rn_ahtbbl: 1000
          namctl:
             ln_ctl: '.false.'
             nn_timing: 0
          # with AGRIF always use linear free surface
          # always set free_surface: linear with AGRIF
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'
       namelist_cfg:
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'
    
    add_coupling_fields:
        "[[agr1_t_fields-->FIELD]]":
            grid: agr1
        "[[agr1_c_fields-->FIELD]]":
            grid: agr1
        "[[agr1_r_fields-->FIELD]]":
            grid: agr1r
        "[[agr1_rc_fields-->FIELD]]":
            grid: agrc
        "[[agr2_t_fields-->FIELD]]":
            grid: agr2

  ORCA05_LIM2_FOCI_AGRIF_MOPS_OASISMCT4:
    requires:
    # seb-wahl: workaround if used with OIFS which also uses XIOS which causes XIOS
    # to be cloned and compiled twice, need to file an issue
    #- xios-2.5_r1910
    - nemobasemodel-3.6foci
    branch: esm-tools
    git-repository: https://git.geomar.de/foci/src/nemo_config/ORCA05_LIM2_FOCI_AGRIF_MOPS.git 
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    archfile: ESMTOOLS_generic_oasis_intel_agrif
    
    # use tracer in AGRIF?
    use_tracer_agrif: true
    # use LIM2 in AGRIF?
    use_lim2_agrif: true
    free_surface: linear
    leapyear: true  

   # coupling fields
    opac_mops_fields: [O_AtmCO2, CO2FLXOC]
    opat_mops_fields: [CO2OCEAN, CO2TRA, FF_OCE]
    
    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h
       1_sn_tem_levitus: 1_sn_tem_levitus
       1_sn_sal_levitus: 1_sn_sal_levitus
       1_ice_init: 1_ice_init
       # reference namelists
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       1_namelist_top_ref: 1_namelist_top_ref
       # grids and coefficients
       cn_batmeter: bathy_updated
       1_cn_batmeter: 1_bathy_meter
       1_coordinates: 1_coordinates
       fixed_grids: fixed_grids
       # reshape files for nest
       1_reshape_bicub: 1_reshape_bicub
       1_reshape_bilin: 1_reshape_bilin

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref
       1_namelist_ref: 1_namelist_ref
       1_namelist_ice_ref: 1_namelist_ice_ref
       1_namelist_top_ref: 1_namelist_top_ref
       1_coordinates: 1_coordinates_ORCA05.nc
    
    add_config_files:
       1_namelist_cfg: 1_namelist_cfg
       1_namelist_ice_cfg: 1_namelist_ice_cfg
       1_namelist_top_cfg: 1_namelist_top_cfg

    add_namelist_changes:
       1_namelist_cfg:
          namrun:
             cn_exp: ${expid}
             nn_it000: ${thisstep_nest}
             nn_itend: ${newstep_nest}
             nn_date0: ${initial_date!syear!smonth!sday} # ${ini_date}
             cn_ocerst_in: ${parent_expid}_${prevstep_formatted_nest}_restart_${parent_date!syear!smonth!sday}${global_tag}
             cn_ocerst_indir: '${parent_restart_dir}/'
             cn_ocerst_out: restart_${end_date_m1!syear!smonth!sday}
             cn_ocerst_outdir: '${experiment_restart_out_dir}/'
             nn_stock: ${newstep_nest}
             nn_leapy: ${nn_leapy}
             nn_rstctl: ${nn_rstctl}
             ln_rstart: ${nemo.lresume}
          #namcfg:
          #   jpidta: ${_nx_nest1}
          #   jpjdta: ${_ny_nest1}
          #   jpiglo: ${_nx_nest1}
          #   jpjglo: ${_ny_nest1}
          namlbc: 
             rn_shlat: 2
             ln_vorlat: '.false.'
          namagrif:
             #nn_cln_update: 3
             rn_sponge_tra: 600 
             rn_sponge_dyn: 600 
          namtsd:
             ln_tsd_tradmp: ${ln_tsd_tradmp}
             ln_tsd_init: ${ln_tsd_init}
          namdom:
             nn_closea: 1
             nn_msh: ${nn_msh}
             rn_rdt: ${time_step_nest}
          namsbc:
             nn_fsbc: 3
             nn_ice: 2
             ln_echam: '.false.'
             ln_cpl: '.true.'
          namtra_ldf: 
             rn_aeiv_0: 0.
             rn_aht_0: 120.
             rn_aht_m: 120.
          namdyn_ldf:
             rn_ahm_0_blp: -2.4e10
             rn_ahm_m_blp: -8.e9
             rn_ahm_m_lap: 0.
          nammpp:
             jpni: ${jpni}
             jpnj: ${jpnj}
             jpnij: ${nproc}
          #namnc4:
          #   ln_nc4zip: '.false.'
          #   nn_nchunks_i: 4
          #   nn_nchunks_j: 4
          #   nn_nchunks_k: 4
          nambbl:
             rn_ahtbbl: 1000
          namctl:
             ln_ctl: '.false.'
             nn_timing: 0
          # with AGRIF always use linear free surface
          # always set free_surface: linear with AGRIF
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'
       namelist_cfg:
          namdyn_hpg:
             ln_hpg_zps: '.true.'
             ln_hpg_sco: '.false.'
             ln_dynhpg_imp: '.true.'
       # workaround for bug in f90nml library used by esm_runscripts, see
       # https://github.com/esm-tools/esm_tools/issues/633 and
       # https://github.com/marshallward/f90nml/issues/110
       namelist_top_cfg:
         namtrc:
          sn_tracer: "remove_from_namelist"
          sn_tracer(1)%clsname: AGE
          sn_tracer(2)%clsname: PO4
          sn_tracer(3)%clsname: DOP
          sn_tracer(4)%clsname: O2
          sn_tracer(5)%clsname: PHY
          sn_tracer(6)%clsname: ZOO
          sn_tracer(7)%clsname: DET
          sn_tracer(8)%clsname: DIN
          sn_tracer(9)%clsname: DIC
          sn_tracer(10)%clsname: ALK
          sn_tracer(11)%clsname: IDEAL

          sn_tracer(1:11)%cllname: "     "

          sn_tracer(1)%clunit: s
          sn_tracer(2:8)%clunit: mmol/m3
          sn_tracer(9:10)%clunit: umol/kg
          sn_tracer(11)%clunit: mmol/m3

          sn_tracer(1)%llinit: false
          sn_tracer(2)%llinit: true
          sn_tracer(3)%llinit: false
          sn_tracer(4)%llinit: true
          sn_tracer(5:7)%llinit: false
          sn_tracer(8:11)%llinit: true

          sn_tracer(1:11)%llsave: true

       1_namelist_top_cfg:
         namtrc:
          sn_tracer: "remove_from_namelist"
          sn_tracer(1)%clsname: AGE
          sn_tracer(2)%clsname: PO4
          sn_tracer(3)%clsname: DOP
          sn_tracer(4)%clsname: O2
          sn_tracer(5)%clsname: PHY
          sn_tracer(6)%clsname: ZOO
          sn_tracer(7)%clsname: DET
          sn_tracer(8)%clsname: DIN
          sn_tracer(9)%clsname: DIC
          sn_tracer(10)%clsname: ALK
          sn_tracer(11)%clsname: IDEAL

          sn_tracer(1:11)%cllname: "     "

          sn_tracer(1)%clunit: s
          sn_tracer(2:8)%clunit: mmol/m3
          sn_tracer(9:10)%clunit: umol/kg
          sn_tracer(11)%clunit: mmol/m3

          sn_tracer(1)%llinit: false
          sn_tracer(2)%llinit: true
          sn_tracer(3)%llinit: false
          sn_tracer(4)%llinit: true
          sn_tracer(5:7)%llinit: false
          sn_tracer(8:11)%llinit: true

          sn_tracer(1:11)%llsave: true
    
    add_coupling_fields:
        "[[opat_mops_fields-->FIELD]]":
            grid: opat
        "[[opac_mops_fields-->FIELD]]":
            grid: opac
        "[[agr1_t_mops_fields-->FIELD]]":
            grid: agr1
        "[[agr1_c_mops_fields-->FIELD]]":
            grid: agr1
        "[[agr1_t_fields-->FIELD]]":
            grid: agr1
        "[[agr1_c_fields-->FIELD]]":
            grid: agr1
        "[[agr1_r_fields-->FIELD]]":
            grid: agr1r
        "[[agr1_rc_fields-->FIELD]]":
            grid: agrc
        "[[agr2_t_fields-->FIELD]]":
            grid: agr2

  ORCA05_LIM2_KCM_AOW:
    requires:
    #- xios-2.0_r982
    - nemobasemodel-3.6foci
    branch: master
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git
    leapyear: true  

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       sn_sal_diag: sn_sal_levitus
       ice_init: ice_init_kkg36f13h

    input_in_work:
       ice_init: Ice_initialization.nc
       sn_sal_diag: sali_ref_clim_monthly.nc
       namelist_ice_ref: namelist_ice_ref

  ORCA05_LIM2_KCM_AOW_autotools:
    requires:
    - nemobasemodel-3.6foci_autotools
    branch: master_autotools
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/ORCA05_LIM2_KCM_AOW.git
    leapyear: true  

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref

  ORCA05_LIM2_KCM_AOW_FS:
    requires:
    #- xios-2.0_r982
    - nemobasemodel-3.6foci
    branch: master
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git

    free_surface: nonlinear
    leapyear: true  

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref

  ORCA05_LIM2_KCM_AOW_OASISMCT4:
    requires:
    #- xios-2.0_r982
    - nemobasemodel-3.6foci
    branch: oasismct4 
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/ORCA05_LIM2_KCM_AOW.git

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref

  ORCA05_LIM2_KCM_AOW_FS_OASISMCT4:
    requires:
    - nemobasemodel-3.6foci
    branch: esm-tools
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git

    free_surface: nonlinear
    leapyear: true  

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref

  ORCA05_LIM2_FOCI_MOPS_OASISMCT4:
    requires:
    - nemobasemodel-3.6foci
    branch: esm-tools-oasismct4
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/ORCA05_LIM2_FOCI_MOPS.git

    # tracers are used by default
    free_surface: nonlinear
    leapyear: true  

    # workaround for bug in f90nml library used by esm_runscripts, see 
    # https://github.com/esm-tools/esm_tools/issues/633 and 
    # https://github.com/marshallward/f90nml/issues/110
    add_namelist_changes:
      namelist_top_cfg:
        namtrc:
          sn_tracer: "remove_from_namelist"
          sn_tracer(1)%clsname: AGE 
          sn_tracer(2)%clsname: PO4
          sn_tracer(3)%clsname: DOP
          sn_tracer(4)%clsname: O2
          sn_tracer(5)%clsname: PHY
          sn_tracer(6)%clsname: ZOO
          sn_tracer(7)%clsname: DET
          sn_tracer(8)%clsname: DIN
          sn_tracer(9)%clsname: DIC
          sn_tracer(10)%clsname: ALK
          sn_tracer(11)%clsname: IDEAL

          sn_tracer(1:11)%cllname: "     "

          sn_tracer(1)%clunit: s
          sn_tracer(2:8)%clunit: mmol/m3
          sn_tracer(9:10)%clunit: umol/kg
          sn_tracer(11)%clunit: mmol/m3

          sn_tracer(1)%llinit: false
          sn_tracer(2)%llinit: true
          sn_tracer(3)%llinit: false
          sn_tracer(4)%llinit: true
          sn_tracer(5:7)%llinit: false
          sn_tracer(8:11)%llinit: true

          sn_tracer(1:11)%llsave: true

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       # init and (if used) damping data
       sn_tem: sn_tem_levitus
       sn_sal: sn_sal_levitus
       ice_init: ice_init_kkg36f13h

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref

    add_coupling_fields:
        "[[opat_mops_fields-->FIELD]]":
                grid: opat
        "[[opac_mops_fields-->FIELD]]":
                grid: opac
  
  
  #ORCA05_SI3_FOCI_FS_AOW:
  #  requires:
  #  - nemobasemodel-4.2.xfoci
  #  branch: esm-tools
  #  destination: nemo-${nemo.version}/cfgs/${nemo.version}
  #  git-repository: https://github.com/joakimkjellsson/ORCA05_SI3_FOCI_FS_AOW
  #  namelist_dir: ${nemo.model_dir}/cfgs/${nemo.version}/EXPREF/
  #  add_input_sources:
  #      namelist_ref: ${nemo.model_dir}/cfgs/SHARED/namelist_ref
  #  generation: "4.2"

  ORCA12_LIM2_KCM_AOW_FS_OASISMCT4:
    requires:
    - nemobasemodel-3.6foci
    branch: esm-tools
    destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git

    free_surface: nonlinear
    
    levels: L75

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       # init and (if used) damping data
       sn_tem: sn_tem_EN4_ORCA12
       sn_sal: sn_sal_EN4_ORCA12
       ice_init: ice_init_orca12

    input_in_work:
       ice_init: Ice_initialization.nc
       namelist_ice_ref: namelist_ice_ref
    
    add_namelist_changes:
       namelist_cfg:
          namcfg:
             jperio: 4 # T-fold instead of F-fold
          namtra_adv: 
             ln_traadv_tvd: '.false.'
             ln_traadv_tvd_zts: '.true.'
          namtra_ldf:
             ln_traldf_grif: '.true.'
             rn_aht_0: 125.
             rn_aht_m: 125.
          namdyn_adv:
             ln_dynzad_zts: '.true.'
          #namdyn_ldf:
          #   rn_ahm_0_blp: -2.4e10
          #   rn_ahm_m_blp: -8.e9
          namsbc_rnf:
             sn_cnf: ['rnf_cal_msk', 0, 'rnfmsk', .false., .true., 'yearly', '', '', '']
             cn_dir: './' 
             ln_rnf_mouth: '.true.'
             rn_hrnf: 15.
             rn_avt_rnf: 1e-3
             rn_rfact: 1.0
       
       namelist_ice_cfg:
          namicedyn:
             ahi0: 200  # reduce horizontal eddy diffusivity coefficient for sea-ice [m2/s]
             telast: 120 # timescale for elastic EVP waves

  # NEMO standalone setup
  ORCA05_LIM2_NEMO_JRA55_test:
    requires:
    - xios-2.5_r1910_ogcm
    - nemobasemodel-3.6ogcm_test
    branch: master 
    archfile: ESMTOOLS_generic_intel
    #destination: nemo-${nemo.version}
    # clone destination is a workaround implemented into esm_master for the fact that 
    # "destination" is used as both the target directory for a "git clone ... destination"
    # and the top level direcotory.
    clone_destination: nemo-${nemo.version}/CONFIG/${nemo.version}
    #
    #original repository is the one below. seb-wahl made a copy in 02/2020
    #since not all FOCI testes have access the original repository
    #git-repository: https://git.geomar.de/cmip6-omip/GEOMAR05.CORE-cycle6.git
    git-repository: https://git.geomar.de/foci/src/nemo_config/${nemo.version}.git

    comp_command: export NEMO_TOPLEVEL=${model_dir} ; 
      if ! test -f ARCH/arch-${archfile}.fcm ; then cp CONFIG/${version}/EXP00/arch-${archfile}.fcm ARCH/; fi; 
      cd CONFIG ; 
      cp ${version}/cfg.inc cfg.txt; 
      ./makenemo -n ${version} -m ${archfile} -j 24 ; 
      cp -p ${version}/BLD/bin/nemo.exe ${version}/BLD/bin/oceanx ; cd ../ ;

    clean_command: cd CONFIG ; ./makenemo -n ${nemo.version} -m ${archfile} -r ${nemo.version} clean ; cd ../ 

    # override hardcoded path to runoff forcing
    add_namelist_changes:
       namelist_cfg:
          namsbc_rnf:
             cn_dir: "./"

    add_input_files:
       # reference namelists
       namelist_ref: namelist_ref
       namelist_ice_ref: namelist_ice_ref
       # grids and coefficients 
       cn_batmeter: bathy_meter 
       coordinates: coordinates
       subbasins: subbasins
       coef-G70: coef-G70
       reshape_jra_orca05_bicub: reshape_jra_orca05_bicub 
       reshape_jra_orca05_bilin: reshape_jra_orca05_bilin

       # init data
       sn_tem: sn_tem_woa13_omip
       sn_sal: sn_sal_woa13_omip
       #ice_init: ice_init_orca05
       ice_init: ice_init_kkg36f13h

       # restoring data / mask
       sn_sss: sn_sss_phc21_woa98
       cn_resto: cn_resto_medsea
       
    input_in_work:
      # TODO: Jan Klaus Rieck used subbasins__3.6.0_ORCA05_Kv1.0.0.nc
      # subbasins: orca05_subbasins_3.6.nc
      # TODO: Jan Klaus Rieck used bfr_coef__3.6.0_ORCA05_Kv1.0.0.nc 
      coef-G70: bfr_coef.nc
      reshape_jra_orca05_bicub: reshape_jra_orca05_bicub.nc 
      reshape_jra_orca05_bilin: reshape_jra_orca05_bilin.nc

      sn_tem: data_tem.nc
      sn_sal: data_sal.nc
      sn_sss: Levitus_p2.1_1m_01_12_S_correc_ORCA_R05_SSS_EB_time.nc 
      ice_init: Ice_initialization.nc
      namelist_ice_ref: namelist_ice_ref
      
    forcing_files:
      # forcing data
      sn_wndi: sn_wndi
      sn_wndj: sn_wndj
      sn_qsr: sn_qsr
      sn_qlw: sn_qlw
      sn_tair: sn_tair
      sn_humi: sn_humi
      sn_prec: sn_prec
      sn_snow: sn_snow
      sn_rnf: sn_rnf

    forcing_in_work:
        sn_wndi: "uas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_wndj: "vas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_qsr: "rsds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_qlw: "rlds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_tair: "tas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_humi: "huss-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_prec: "prra_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_snow: "prsn_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr.nc"
        sn_rnf: "sorunoff_JRA55-do-1-5-0_gr_eorca025_y@YEAR@.nc"

    forcing_sources:
        # JRA55-do drowned forcing
        sn_wndi:
          "${jra55_forcing_dir}/uas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_wndj:
          "${jra55_forcing_dir}/vas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_qsr:
          "${jra55_forcing_dir}/rsds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_qlw:
          "${jra55_forcing_dir}/rlds-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_tair:
          "${jra55_forcing_dir}/tas-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_humi:
          "${jra55_forcing_dir}/huss-drowned_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_prec:
          "${jra55_forcing_dir}/prra_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_snow:
          "${jra55_forcing_dir}/prsn_input4MIPs_atmosphericState_OMIP_MRI-JRA55-do-1-4-0_gr_y@YEAR@.nc":
             from: 1958
             to: 1960
        sn_rnf:
          "${jra55_runoff_dir}/sorunoff_JRA55-do-1-5-0_gr_eorca025_y@YEAR@.nc":
             from: 1958
             to: 1960

metadata:
        Organization: Nucleus for European Modelling of the Ocean
        Institute: IPSL
        Description:
                NEMO standing for Nucleus for European Modelling of the Ocean is a
                state-of-the-art modelling framework for research activities and
                forecasting services in ocean and climate sciences, developed in a
                sustainable way by a European consortium.
        Authors: Gurvan Madec and NEMO System Team (nemo_st@locean-ipsl.umpc.fr)
        Publications:
                NEMO ocean engine <http://doi.org/10.5281/zenodo.1464816>
        License:
                Please make sure you have a license to use NEMO. In case you are
                unsure, please contact redmine...

resolution:     ORCA05
levels:         L46
time_step:      1800
jpni:           0 
jpnj:           0
nproc:          $(( ${jpni} * ${jpnj} )) 

use_lim2:       true
use_tracer:     true
hosing:         false
lresume:        false
free_surface:   linear
correct_neg_tracer_conc: true
# use damping?
ln_tsd_tradmp: false 

# Nest settings
nest1: no
use_tracer_agrif:   false
use_lim2_agrif:     false

# calendar:
leapyear: False 

# Restart or initial run settings
# values below will be set to false if lresume = true
ln_tsd_init: true 
ln_limini: true 
# in NEMO4.x limini is called ln_iceini
ln_iceini: ${ln_limini} 
ln_limini_agrif: false
nn_msh: 1
ln_meshmask: true
# will be set to 0 if lresume = true and run_number=1
# i.e. restart from another run
nn_rstctl: 2
# tracer stuff
ln_rsttr: ${lresume} 
nn_rsttr : 2
ln_trcdta: true

# default directories
pool_dir: ${computer.pool_directories.focipool}
input_dir: ${pool_dir}/NEMO_${resolution}/input/${resolution}
namelist_dir: ${nemo.model_dir}/CONFIG/${nemo.version}/EXP00

model_dir: ${general.model_dir}/nemo-${nemo.version}
setup_dir: ${general.model_dir}
bin_dir: ${setup_dir}/bin

# AGRIF
agrif_dir: ${pool_dir}/AGRIF/agrif_${nest1}

# forcing for uncoupled setups
jra55_forcing_dir: ${pool_dir}/JRA55-do/v1.5
jra55_runoff_dir: ${pool_dir}/NEMO_ORCA05_JRA_runoff_forcing 

# start_date_m1: $((${start_date} - ${time_step}seconds))
end_date_m1: $((${next_date} - ${time_step}seconds))
runtime: $((${next_date} - ${start_date}))
timestep_per_run: $(( ${runtime} / ${time_step} ))

seconds_since_initial: $((${start_date} - ${initial_date}))
steps_since_initial: $(( ${seconds_since_initial} / ${time_step}))

prevstep: ${steps_since_initial}
thisstep: $(( ${prevstep} + 1))
newstep: $(( ${prevstep} + ${timestep_per_run} ))

prevstep_formatted: "<--format(%08d)-- ${prevstep}"
thisstep_formatted: "<--format(%08d)-- ${thisstep}"
newstep_formatted: "<--format(%08d)-- ${newstep}"

time_step_nest: $(( ${time_step} / ${nest_refinement} ))
prevstep_nest: $(( ${steps_since_initial} * ${nest_refinement} ))
thisstep_nest: $(( ${prevstep_nest} + 1 ))
timesteps_per_run_nest: $(( ${timestep_per_run} * ${nest_refinement} ))
newstep_nest: $(( ${prevstep_nest} + ${timesteps_per_run_nest} ))

prevstep_formatted_nest: "<--format(%08d)-- ${prevstep_nest}"
thisstep_formatted_nest: "<--format(%08d)-- ${thisstep_nest}"
newstep_formatted_nest: "<--format(%08d)-- ${newstep_nest}"

# generate settings for a restart from a different run
ini_restart_steps: 0 # this value will be/needs to be set in the runscript
ini_restart_steps_nest: $(( ${ini_restart_steps} * ${nest_refinement} ))
global_tag: ""
   
coupling_freq_in_steps: 6

# TODO: link with model start and end
#jrastart: 1958
#jraend: 1960


namelist_changes:
        namelist_cfg:
                namrun:
                        cn_exp: ${expid}
                        nn_it000: ${thisstep}
                        nn_itend: ${newstep}
                        nn_date0: ${initial_date!syear!smonth!sday} # ${ini_date}
                        cn_ocerst_in: ${parent_expid}_${prevstep_formatted}_restart_${parent_date!syear!smonth!sday}${global_tag} 
                        cn_ocerst_indir: '${parent_restart_dir}/'
                        cn_ocerst_out: restart_${end_date_m1!syear!smonth!sday}
                        cn_ocerst_outdir: '${experiment_restart_out_dir}/'
                        nn_stock: ${newstep}
                        nn_leapy: ${nn_leapy} 
                        nn_rstctl: ${nn_rstctl} 
                        ln_rstart: ${nemo.lresume}
                namtsd:                                                
                        #ln_tsd_tradmp: ${ln_tsd_tradmp} 
                        ln_tsd_init: ${ln_tsd_init} 
                namsbc:
                        nn_fsbc: ${coupling_freq_in_steps}
                nammpp:
                        jpni: ${jpni}
                        jpnj: ${jpnj}

choose_generation:
        "4.2": 
                opat_fields: [O_AlbIce, OIceFrc, O_SSTSST, O_TepIce, OIceTck, OSnwTck, O_OCurx1, O_OCury1, O_OTaux1, O_OTauy1, O_ITaux1, O_ITauy1]

                add_namelist_changes:
                        namelist_cfg:
                                namdom:
                                        rn_dt: ${time_step}
                                        ln_meshmask: ${ln_meshmask}
                                namcfg:
                                        ln_closea: '.false.'
                                namtsd: 
                                        ln_tsd_dmp: ${ln_tsd_tradmp}
                choose_free_surface:
                   # for linear we use the default (false), so no settings required
                   nonlinear:
                      add_namelist_changes:
                         namelist_cfg:
                            namdyn_hpg:
                               ln_hpg_sco: '.true.'
        "3.6":
                choose_sst_grid_name: 
                        "opat":
                                opat_fields: [OIceFrac, O_SSTSST, O_TepIce, O_IceTck, O_SnwTck, O_OCurx1, O_OCury1, O_OTaux1, O_OTauy1, O_ITaux1, O_ITauy1]
                        "opac":
                                opat_fields: []
                                opac_fields: [O_QsrIce, O_QsrMix, O_QnsIce, O_QnsMix, OTotRain, OTotSnow, OIceEvap, OTotEvap, O_dQnsdT, OIceFrac, O_SSTSST, O_TepIce, O_IceTck, O_SnwTck, O_OCurx1, O_OCury1, O_OTaux1, O_OTauy1, O_ITaux1, O_ITauy1] 
                add_namelist_changes:
                        namelist_cfg:
                                namdom:
                                        nn_closea: 1
                                        nn_msh: ${nn_msh}
                                        rn_rdt: ${time_step}
                                nammpp:
                                        jpnij: ${nproc}
                                namtsd: 
                                        ln_tsd_tradmp: ${ln_tsd_tradmp}
                choose_free_surface:
                   linear:
                      add_namelist_changes:
                         namelist_cfg:
                            namdyn_hpg:
                               ln_hpg_zps: '.true.'
                               ln_hpg_sco: '.false.'
                               ln_dynhpg_imp: '.true.'
                   nonlinear:
                      add_namelist_changes:
                         namelist_cfg:
                            namdyn_hpg:
                               ln_hpg_zps: '.false.'
                               ln_hpg_sco: '.true.'
                               ln_dynhpg_imp: '.false.'
                
choose_leapyear:
        False:
              nn_leapy: 0 
        True:
              nn_leapy: 1 

choose_hosing:
        true:
                add_namelist_changes:
                        namelist_cfg:
                                namdyn_sbc:
                                        ln_hosing: '.true.'

choose_lresume:
        true:
                ln_limini: false
                ln_limini_agrif: false
                ln_tsd_init: false
                nn_msh: 0
                ln_meshmask: false
                                        
                choose_general.run_number:
                        1:
                                nn_rstctl: 0
                                nn_rsttr : 0 # only needed if tracers are used
                                # upon restart, nemo restart files are global files and have end on _global.nc (FOCI convention)
                                global_tag: "_global" 
                                prevstep_formatted: "<--format(%08d)-- ${ini_restart_steps}" 
                                prevstep_formatted_nest: "<--format(%08d)-- ${ini_restart_steps_nest}" 

        false:
                add_outdata_sources:
                        mesh_mask: "*mesh_mask*.nc"


# choices:
#
choose_resolution:
        eORCA025:
                _nx: 1440
                _ny: 1206
                time_step: 1200
        ORCA05:
                # Periodic points and folding points
                # are not included on grid for NEMO 4.2
                _nx: 722
                _ny: 511
                time_step: 1800
                
        ORCA12:
                _nx: 4322
                _ny: 3059
                time_step: 300
                
                input_files:
                        namelist_ref: namelist_ref
                        namelist_ice_ref: namelist_ice_ref
                        coordinates: coordinates
                        subbasins: subbasins
                        rnfmask: rnfmask          
                add_input_sources:
                        subbasins: ${input_dir}/ORCA0083_basinmsk_fullarctic.nc
                        rnfmask: ${input_dir}/rnf_cal_msk.nc

        R4:
                free_surface: no_option 
                use_lim2: false 
                #use_tracer: false
                coupling_freq_in_steps: 1
                _nx: 32
                _ny: 22
                time_step: 600
                choose_generation:
                        "3.6":
                                add_namelist_changes:
                                        namelist_cfg: 
                                                namtsd: 
                                                        ln_tsd_tradmp: '.false.' 
                                                        ln_tsd_init: '.false.' 
                                                nameos:
                                                        ln_useCT: '.false.'
                        "4.2":
                                add_namelist_changes:
                                        namelist_cfg:
                                                namtsd:
                                                        ln_tsd_init: '.false.'
                                                        ln_tsd_dmp: '.false.'
                input_files:
                        namelist_ref: namelist_ref
                config_files:        
                        namelist_cfg: namelist_cfg
                input_in_work:
                        namelist_ref: namelist_ref
                config_in_work:        
                        namelist_cfg: namelist_cfg

_nx_nest1: 0
_ny_nest1: 0
nest_refinement: 3
choose_nest1:
        # nest_refinement MUST (!!!) match the last value
        # in AGRIF_FixedGrids.in
        # for backward compatibility with Joakims settings
        viking10:
                _nx_nest1: 884
                _ny_nest1: 869
                nest_refinement: 3
        VIKING10:
                _nx_nest1: 884
                _ny_nest1: 869
                nest_refinement: 3
        INALT10X:
                _nx_nest1: 1404
                _ny_nest1: 924
                nest_refinement: 3
        NPAC10:
                _nx_nest1: 1569
                _ny_nest1: 664
                nest_refinement: 3
        WG10:
                _nx_nest1: 1414
                _ny_nest1: 944
                nest_refinement: 5
        WG10v4:
                _nx_nest1: 1614
                _ny_nest1: 944
                nest_refinement: 5
        ORION10X: 
                _nx_nest1: 3564
                _ny_nest1: 884
                nest_refinement: 5

choose_levels:
   L75:
      add_namelist_changes:
         namelist_cfg:
            namcfg: 
               jpkdta: 75 
            namdom:
               # very important to set hmin to -10 or lower
               rn_hmin: -10 
               rn_e3zps_min: 25.0
               rn_e3zps_rat: 0.2
               ppsur: -3958.951371276829 
               ppa0: 103.9530096000000 
               ppa1: 2.415951269000000 
               ppkth: 15.35101370000000 
               ppacr: 7.0
               ppdzmin: 999999.0 
               ldbletanh: '.true.' 
               ppa2: 100.760928500000 
               ppkth2: 48.029893720000 
               ppacr2: 13.000000000000 


choose_use_lim2:
   true:
      add_config_files:
         namelist_ice_cfg: namelist_ice_cfg

      choose_generation:
         "3.6":
            add_namelist_changes:
               namelist_ice_cfg:
                  namicerun:
                     cn_icerst_in: ${parent_expid}_${prevstep_formatted}_restart_ice_${parent_date!syear!smonth!sday}${global_tag}
                     cn_icerst_indir: '${parent_restart_dir}/'
                     cn_icerst_out: restart_ice_${end_date_m1!syear!smonth!sday}
                     cn_icerst_outdir: '${experiment_restart_out_dir}/'
                  namiceini:
                     ln_limini: ${ln_limini} 
         "4.2":
            add_namelist_changes:
               namelist_ice_cfg:
                  nampar:
                     cn_icerst_in: ${parent_expid}_${prevstep_formatted}_restart_ice_${parent_date!syear!smonth!sday}${global_tag}
                     cn_icerst_indir: '${parent_restart_dir}/'
                     cn_icerst_out: restart_ice_${end_date_m1!syear!smonth!sday}
                     cn_icerst_outdir: '${experiment_restart_out_dir}/'
                  namini:
                     ln_iceini: ${ln_iceini} 
                     # initialize sea ice based on SSTs
                     nn_iceini_file: 0

      choose_use_lim2_agrif:
         true:
            add_config_files:
               1_namelist_ice_cfg: 1_namelist_ice_cfg
            add_namelist_changes:
               1_namelist_ice_cfg:
                  namicerun:
                     cn_icerst_in: ${parent_expid}_${prevstep_formatted_nest}_restart_ice_${parent_date!syear!smonth!sday}${global_tag}
                     cn_icerst_indir: '${parent_restart_dir}/'
                     cn_icerst_out: restart_ice_${end_date_m1!syear!smonth!sday}
                     cn_icerst_outdir: '${experiment_restart_out_dir}/'
                  namiceini:
                     ln_limini: ${ln_limini_agrif} 

choose_use_tracer:
   true:
      add_input_files:
         namelist_top_ref: namelist_top_ref
      add_config_files:
         namelist_top_cfg: namelist_top_cfg
      add_namelist_changes:
         namelist_top_cfg:
            namtrc_run:
               cn_trcrst_in: ${parent_expid}_${prevstep_formatted}_restart_trc_${parent_date!syear!smonth!sday}${global_tag}  #${restart_in}
               cn_trcrst_indir: '${parent_restart_dir}/'
               cn_trcrst_out: restart_trc_${end_date_m1!syear!smonth!sday}
               cn_trcrst_outdir: '${experiment_restart_out_dir}/'
               ln_rsttr: ${ln_rsttr} 
               nn_rsttr : ${nn_rsttr}
            namtrc:
               ln_trcdta: ${ln_trcdta} 
            namtrc_rad:
               ln_trcrad: ${correct_neg_tracer_conc} 
               
      choose_use_tracer_agrif:
         true:
            add_config_files:
               1_namelist_top_cfg: 1_namelist_top_cfg
            add_namelist_changes:
               1_namelist_top_cfg:
                  namtrc_run:
                     cn_trcrst_in: ${parent_expid}_${prevstep_formatted_nest}_restart_trc_${parent_date!syear!smonth!sday}${global_tag}  #${restart_in}
                     cn_trcrst_indir: '${parent_restart_dir}/'
                     cn_trcrst_out: restart_trc_${end_date_m1!syear!smonth!sday}
                     cn_trcrst_outdir: '${experiment_restart_out_dir}/'
                     ln_rsttr: ${ln_rsttr} 
                     nn_rsttr : ${nn_rsttr}
                  namtrc:
                     ln_trcdta: ${ln_trcdta} 
                  namtrc_rad:
                     ln_trcrad: ${correct_neg_tracer_conc} 

bin_sources:
        nemo: ${bin_dir}/oceanx

############## input files:

#input_files:

#input_in_work:

input_sources:
        # grids and coefficients
        bathy_meter: ${input_dir}/bathy_meter.nc
        coordinates: ${input_dir}/coordinates.nc
        #subbasins: ${input_dir}/orca05_subbasins_3.6.nc
        coef-G70: ${input_dir}/orca05_bfr_coef-G70.nc
        subbasins: ${input_dir}/orca05_subbasins_3.6.nc 

        reshape_jra_orca05_bicub: ${input_dir}/reshape_jra_bicub__3.6.0_ORCA05_Kv1.0.0.nc 
        reshape_jra_orca05_bilin: ${input_dir}/reshape_jra_bilin__3.6.0_ORCA05_Kv1.0.0.nc

        # inital data
        sn_tem_levitus: ${input_dir}/Levitus_p2.1_1m_01_12_Tpot_ORCA_R05.nc
        sn_tem_woa13_omip: ${input_dir}/woa13_decav_ptemp_OMIPinit__3.6.0_ORCA05.L46_Kv1.0.0.nc
        sn_tem_EN4_ORCA12: ${input_dir}/votemper_EN4_gridded_195001-ORCA12_DROWN.nc
        sn_sal_levitus: ${input_dir}/Levitus_p2.1_1m_01_12_S_correc_ORCA_R05.nc
        sn_sal_woa13_omip: ${input_dir}/woa13_decav_salt_OMIPinit__3.6.0_ORCA05.L46_Kv1.0.0.nc
        sn_sal_EN4_ORCA12: ${input_dir}/vosaline_EN4_gridded_195001-ORCA12_DROWN.nc
        ice_init_kkg36f13h: ${input_dir}/Ice_initialization_KKG36F13H-R.nc
        ice_init_orca05: ${input_dir}/Ice_initialization__3.6.0_ORCA05_Kv1.0.0.nc
        ice_init_orca12: ${input_dir}/Ice_initialization_ORCA12.nc 

        # restoring data / mask
        sn_sss_phc21_woa98: ${input_dir}/Levitus_p2.1_1m_01_12_S_correc_ORCA_R05_SSS_EB.nc
        cn_resto_medsea: ${input_dir}/dmpmsk_MedSea_orca05.l46_RA-II.nc 

        # namelists
        # add namelist_ref as input source to avoid removal of comments which
        # makes namelist unreadable
        namelist_ref: ${nemo.model_dir}/CONFIG/SHARED/namelist_ref
        namelist_ice_ref: ${nemo.model_dir}/CONFIG/SHARED/namelist_ice_lim2_ref
        namelist_top_ref: ${nemo.model_dir}/CONFIG/SHARED/namelist_top_ref

        # AGRIF: grids and coefficients
        bathy_updated: ${agrif_dir}/bathy_updated.nc 
        1_bathy_meter: ${agrif_dir}/1_bathy_meter.nc
        1_coordinates: ${agrif_dir}/1_coordinates_ORCA05.nc 
        fixed_grids: ${agrif_dir}/AGRIF_FixedGrids.in

        # ini files
        1_sn_tem_levitus: ${agrif_dir}/1_Levitus_p2.1_1m_01_12_Tpot_ORCA_R05.nc
        1_sn_sal_levitus: ${agrif_dir}/1_Levitus_p2.1_1m_01_12_S_correc_ORCA_R05.nc
        1_ice_init: ${agrif_dir}/1_Ice_initialization.nc

        # reshape files for nest, only required with file based coupling
        # TODO: replace T63 with proper variable
        1_reshape_bicub: ${agrif_dir}/1_reshape_T63invert_${nest1}_bicub.nc 
        1_reshape_bilin: ${agrif_dir}/1_reshape_T63invert_${nest1}_bilin.nc 

        # add namelist_ref as input source to avoid removal of comments which
        # makes namelist unreadable
        1_namelist_ref: ${nemo.model_dir}/CONFIG/SHARED/namelist_ref
        1_namelist_ice_ref: ${nemo.model_dir}/CONFIG/SHARED/namelist_ice_lim2_ref
        1_namelist_top_ref: ${nemo.model_dir}/CONFIG/SHARED/namelist_top_ref

        # NEMO 4.2.x eORCA025 input files
        # grids and coefficients
        coordinates_eORCA025: ${input_dir}/coordinates_eORCA025_r4.2.0__v1.0.nc
        bfr_coef_eORCA025: ${input_dir}/bfr_coef_eORCA025_r4.2.0.nc
        subbasins_eORCA025: ${input_dir}/subbasins_eORCA025_r4.2.0.nc
        #domain_cfg_eORCA025: ${input_dir}/domain_cfg_eORCA025_r4.2.0__ExclClosedSeas.nc
        domain_cfg_eORCA025: ${input_dir}/domain_cfg_eORCA025.z75_r4.2.0-2.nc
        # TODO: this file still needs to be generated by Markus
        domain_cfg_eORCA025_CaspianSea: ${input_dir}/domain_cfg_eORCA025_r4.2.0__CaspianSea.nc
        # we probably never need this one
        domain_cfg_UKmasks: ${input_dir}/domain_cfg_eORCA025_r4.2.0__UKmasks.nc

        ghflux_v2.0: ${input_dir}/ghflux_v2.0.nc
        reshape_ghflux2_eORCA025: ${input_dir}/reshape_ghflux2_eORCA025_r4.2.0_bilin.nc
        reshape_jra55do_eORCA025_bicub: ${input_dir}/reshape_jra55do_eORCA025_r4.2.0_bicub.nc
        reshape_jra55do_eORCA025_bilin: ${input_dir}/reshape_jra55do_eORCA025_r4.2.0_bilin.nc
        data_tem_eORCA025: ${input_dir}/woa13_decav_ptemp_OMIPinit_eORCA025.L75_4.2.0_Kv1.0.5.nc
        data_sal_eORCA025: ${input_dir}/woa13_decav_salt_OMIPinit_eORCA025.L75_4.2.0_Kv1.0.5.nc
        runoff_eORCA025: ${input_dir}/runoff_b0.2.0_eORCA025_r4.2.0.nc
        seaice_eORCA025: ${input_dir}/seaice_c3.0_v19802004.0_eORCA025_r4.2.0.nc

        # NEMO 4.2.x ORCA05 input files
        # grids and coefficients
        bathy_meter_orca05_nemo4: ${input_dir}/bathy_meter__4.2.0_ORCA05.L46.nc
        coordinates_orca05_nemo4: ${input_dir}/coordinates.nc
        #coordinates_orca05_nemo4: ${input_dir}/bathy_meter__4.2.0_ORCA05.L46.nc
        bfr_coef_orca05_nemo4: ${input_dir}/bfr_coef__4.2.0_ORCA05.nc
        subbasins_orca05_nemo4: ${input_dir}/subbasins__4.2.0_ORCA05.nc
        # File from Joakim. Use same settings as ORCA05 in 3.6
        # (zps, no isf, Caspian included)
        domain_cfg_orca05_nemo4: ${input_dir}/domain_cfg__ORCA05_zps_noclo.nc
        #domain_cfg_orca05_nemo4: ${input_dir}/domain_cfg_ORCA05_v1.1.nc
       
        reshape_jra_orca05_nemo4_bicub: ${input_dir}/reshape_jra_bicub__4.2.0_ORCA05_v1.0.0.nc
        reshape_jra_orca05_nemo4_bilin: ${input_dir}/reshape_jra_bilin__4.2.0_ORCA05_v1.0.0.nc
        
        # inital data
        #data_tem_orca05_nemo4: ${input_dir}/Tpot_PHC2.1_WOA98__4.2.0_ORCA05.L46_Kv1.0.0.nc
        #data_sal_orca05_nemo4: ${input_dir}/Salt_PHC2.1_WOA98__4.2.0_ORCA05.L46_Kv1.0.0.nc
        #sss_orca05_nemo4: ${input_dir}/SSS_PHC2.1_WOA98__4.2.0_ORCA05.L46_Kv1.0.0.nc
        #runoff_orca05_nemo4: ${input_dir}/runoff_12month__4.2.0_ORCA05_Kv1.0.0.nc
        data_tem_orca05_nemo4: ${input_dir}/Tpot_PHC2.1_WOA98__4.2.0_ORCA05.L46_Kv1.0.0.nc
        data_sal_orca05_nemo4: ${input_dir}/Salt_PHC2.1_WOA98__4.2.0_ORCA05.L46_Kv1.0.0.nc
        seaice_orca05_nemo4: ${input_dir}/seaice_c3.0_v19802004.0_ORCA05_r4.2.0.nc
        
        # remapped ghflux to orca05
        ghflux_v2.0_orca05_nemo4: ${input_dir}/ghflux_v2.0_ORCA05.nc
        
#forcing_files:

############## config files / namelist files:

config_files:
        namelist_cfg: namelist_cfg

config_sources:
        namelist_cfg: ${namelist_dir}/namelist_cfg
        namelist_top_cfg: ${namelist_dir}/namelist_top_cfg
        namelist_ice_cfg: ${namelist_dir}/namelist_ice_cfg
        1_namelist_cfg: ${namelist_dir}/1_namelist_cfg
        1_namelist_top_cfg: ${namelist_dir}/1_namelist_top_cfg
        1_namelist_ice_cfg: ${namelist_dir}/1_namelist_ice_cfg

config_in_work:
        namelist_cfg: namelist_cfg
        namelist_ice_cfg: namelist_ice_cfg
        namelist_top_cfg: namelist_top_cfg
        1_namelist_cfg: 1_namelist_cfg
        1_namelist_ice_cfg: 1_namelist_ice_cfg
        1_namelist_top_cfg: 1_namelist_top_cfg

namelists:
        - namelist_cfg
        - namelist_top_cfg
        - namelist_ice_cfg
        - 1_namelist_cfg
        - 1_namelist_top_cfg
        - 1_namelist_ice_cfg

############## restart files:
# restart files are handled by namelist_cfg and written to / read from the 
# permanent restart directory directly

############## output files:

outdata_sources:
         1h: "*${expid}_1h_${start_date!syear!smonth!sday}_${end_date_m1!syear!smonth!sday}_*.nc"
         3h: "*${expid}_3h_${start_date!syear!smonth!sday}_${end_date_m1!syear!smonth!sday}_*.nc"
         6h: "*${expid}_6h_${start_date!syear!smonth!sday}_${end_date_m1!syear!smonth!sday}_*.nc"
         1d: "*${expid}_1d_${start_date!syear!smonth!sday}_${end_date_m1!syear!smonth!sday}_*.nc"
         5d: "*${expid}_5d_${start_date!syear!smonth!sday}_${end_date_m1!syear!smonth!sday}_*.nc"
         1m: "*${expid}_1m_${start_date!syear!smonth!sday}_${end_date_m1!syear!smonth!sday}_*.nc"

############## log files:

log_sources:
        tracer:  tracer.stat
        ocean:  '*ocean.output'
        namout: output.namelist.*
        solver_stat: solver.stat
        time_step: time.step
        layout: layout.dat

##########################  coupling stuff

sst_grid_name: "opat"
opat_fields: [OIceFrac, O_SSTSST, O_TepIce, O_IceTck, O_SnwTck, O_OCurx1, O_OCury1, O_OTaux1, O_OTauy1, O_ITaux1, O_ITauy1]
opat_mops_fields: [CO2OCEAN, CO2TRA, FF_OCE]

opac_fields: [O_QsrIce, O_QsrMix, O_QnsIce, O_QnsMix, OTotRain, OTotSnow, OIceEvap, OTotEvap, O_dQnsdT]
opac_mops_fields: [O_AtmCO2, CO2FLXOC]

agr1_t_fields: [1_OIceFrac, 1_O_SSTSST, 1_O_TepIce, 1_O_IceTck, 1_O_SnwTck, 1_O_OCurx1, 1_O_OCury1, 
                1_O_OTaux1, 1_O_OTauy1, 1_O_ITaux1, 1_O_ITauy1]
agr1_t_mops_fields: [1_CO2OCEAN, 1_CO2TRA, 1_FF_OCE]

agr1_c_fields: [1_O_QsrIce, 1_O_QsrMix, 1_O_QnsIce, 1_O_QnsMix, 1_OTotRain, 1_OTotSnow, 1_OTotEvap, 1_OIceEvap, 1_O_dQnsdT]
agr1_c_mops_fields: [1_O_AtmCO2, 1_CO2FLXOC]

agr2_t_fields: [1_O_AgrSpg]
# default needs to be set even if not used
agr1_rc_fields: [1_OCalving]

coupling_fields:
        "[[opat_fields-->FIELD]]":
                grid: opat
        "[[opac_fields-->FIELD]]":
                grid: opac

choose_runoff_method:
        # EM21 developed by Eric Maisonnave in 2021
        # Runoff is split to river and calving. 
        # Also remapped from runoff mapper grid (rnfm) 
        # to the opac grid (for NEMO) and agr1 (for AGRIF)
        "EM21":
                ornf_fields: [O_Runoff]
                ocal_fields: [OCalving]
                agr1_r_fields: [1_O_Runoff]
                agr1_rc_fields: [1_OCalving]
                add_coupling_fields:
                        "[[ornf_fields-->FIELD]]":
                                grid: opac
                        "[[ocal_fields-->FIELD]]":
                                grid: opaa
                        "[[agr1_r_fields-->FIELD]]":
                                grid: agr1
                        "[[agr1_rc_fields-->FIELD]]":
                                grid: agrc
        
        # Old method based on remapping runoff to a pre-made
        # runoff mask on the ORCA05 grid (rnfo) or AGRIF (agr1r)
        "*":
                ornf_fields: [O_Runoff]
                agr1_r_fields: [1_O_Runoff]
                add_coupling_fields:
                        "[[ornf_fields-->FIELD]]":
                                grid: rnfo
                        "[[agr1_r_fields-->FIELD]]":
                                grid: agr1r

grids:
        opat:
                name: opat
                nx: ${_nx}
                ny: ${_ny}
                oasis_grid_type: "LR"
                number_of_overlapping_points: 2 # oasis P-value
        opac:
                name: opac
                nx: ${_nx}
                ny: ${_ny}
                oasis_grid_type: "LR" #??? not sure, doesn't matter
                number_of_overlapping_points: 2 # oasis P-value
        opaa:   
                name: opaa
                nx: ${_nx}
                ny: ${_ny}
                oasis_grid_type: "LR"
                number_of_overlapping_points: 0
        #opar:
        #        name: opar
        #        nx: ${_nx}
        #        ny: ${_ny}
        #        oasis_grid_type: "LR"
        #        number_of_overlapping_points: 2 
        rnfo:
                name: rnfo
                nx: ${_nx}
                ny: ${_ny}
                oasis_grid_type: "LR"
                number_of_overlapping_points: 0
        agr1:
                name: agr1
                nx: ${_nx_nest1}
                ny: ${_ny_nest1}
                oasis_grid_type: "LR"
                number_of_overlapping_points: 0
        agr2: 
                name: agr2
                nx: ${_nx_nest1}
                ny: ${_ny_nest1}
                oasis_grid_type: "LR"
                number_of_overlapping_points: 0
        agr1r:
                name: agr1r
                nx: ${_nx_nest1}
                ny: ${_ny_nest1}
                oasis_grid_type: "LR"
                number_of_overlapping_points: 0
        
        # agrc: AGRIF grid but with a mask corresponding to calving
        agrc:   
                name: agrc
                nx: ${_nx_nest1}
                ny: ${_ny_nest1}
                oasis_grid_type: "LR"
                number_of_overlapping_points: 0

